# デュエル・マスターズ 競技用AI実装仕様書 (Ver 2.0)
Based on Official Rules Ver. 1.47

## 1. 基本原則 (Fundamental Rules)

### 1.1 優先順位
1.  **カード > ルール**: カードのテキストがルールと矛盾する場合、カードの記述を優先する (101.1)。
2.  **禁止 > 許可**: 「できない」効果と「できる」効果が競合する場合、「できない」が優先される (101.2)。
3.  **最大限の履行**: 効果の一部が実行不可能な場合でも、実行可能な部分は全て行う (101.3)。

### 1.2 勝利条件 (Win Conditions)
以下のいずれかを満たした瞬間、ゲームは終了する (104.1)。
1.  **ダイレクトアタック**: 相手シールドが0枚の状態で、クリーチャーの攻撃が通り、攻撃先が変更されなかった場合 (104.2a)。
2.  **ライブラリアウト (LO)**: 山札が0枚になった瞬間 (104.2b)。効果処理の途中でも判定される。
3.  **特殊勝利/敗北**: カード効果による (104.2c)。

## 2. ゲーム構造 (Game Structure)

### 2.1 ゾーン (Zones)
*   **公開**: バトルゾーン、マナゾーン、墓地、超次元ゾーン。
*   **非公開**: 山札、手札、シールドゾーン、超GRゾーン。
*   **マナ**: 1枚タップにつき1マナ発生。多色カードはタップイン（使用可能になるのは次ターン）。

### 2.2 クリーチャーとパワー
*   **パワー0以下**: パワーが0以下になったクリーチャーは、状況起因処理により破壊される (108.1b, 703)。
*   **召喚酔い**: バトルゾーンに出たターンは攻撃できない（「スピードアタッカー」等は例外）。

## 3. ターン進行 (Turn Sequence)

### 3.1 ターン開始ステップ (Start Step)
1.  **アンタップ**: AP（ターンプレイヤー）のマナとバトルゾーンのカードをアンタップ。
2.  **トリガー予約**: 「ターンのはじめに」能力が誘発し、待機状態になる。

### 3.2 ドローステップ (Draw Step)
1.  **ドロー**: APは山札から1枚引く（先攻1ターン目はスキップ）。
2.  **LO判定**: 引けなければ敗北。

### 3.3 マナチャージステップ (Mana Step)
1.  **チャージ**: APは手札から1枚をマナゾーンに置ける（任意）。

### 3.4 メインステップ (Main Step)
APは以下の行動を任意の順序・回数で行える。
*   クリーチャーの召喚。
*   呪文の詠唱。
*   カード効果の起動（クロスギアのジェネレート/クロス等）。

### 3.5 攻撃ステップ (Attack Step)
1.  **攻撃クリーチャー指定**: APは攻撃可能なクリーチャーをタップし、攻撃先（プレイヤーorタップ状態のクリーチャー）を指定。
    *   *攻撃時トリガー*が誘発・予約される。
2.  **ブロッククリーチャー指定**: NAP（非ターンプレイヤー）は「ブロッカー」を持つアンタップクリーチャーでブロック可能。
    *   ブロック成立時、攻撃先がブロッカーに変更され、バトルへ移行。
3.  **バトル / ダイレクトアタック**:
    *   **対クリーチャー**: パワー比較。勝者が残り、敗者は破壊。同値は両者破壊 (115.3b)。
    *   **対シールド**: 指定枚数をブレイク。S・トリガーチェック発生。
    *   **対プレイヤー**: ダイレクトアタック成立で勝利。

### 3.6 ターン終了ステップ (End Step)
1.  **トリガー予約**: 「ターンの終わりに」能力が誘発。
2.  **期間終了**: 「ターン終了時まで」の効果が消滅。

## 4. 効果解決と優先権 (Effect Resolution & Priority)

### 4.1 待機効果の解決順序 (The Stack)
複数の効果が待機状態にある場合、以下の優先順位で処理する (101.4a)。

1.  **S・トリガー / G・ストライク**: 最優先。
    *   APのS・トリガー -> NAPのS・トリガーの順。
2.  **APの待機効果**:
    *   APは自分の待機効果を好きな順序で1つずつ解決する。
3.  **NAPの待機効果**:
    *   APの待機効果が全てなくなった後、NAPは自分の待機効果を好きな順序で解決する。

### 4.2 割り込み処理 (Nested Triggers)
効果解決中に新たな効果が誘発した場合：
1.  その効果は**待機状態 (Pending)** となる。
2.  現在解決中の効果を完了させる。
3.  その後、再び4.1の優先順位に従って、新しく発生した効果を含めて解決を行う。
    *   *例外*: **置換効果** (Replacement Effect) はイベント発生時に即座に適用され、イベントを書き換える (101.5)。待機状態にはならない。

### 4.3 状況起因処理 (State-Based Actions)
効果解決の合間やステップの移行時に常にチェックされる (703)。
*   敗北条件の達成 (LO, 特殊敗北)。
*   パワー0以下のクリーチャーの破壊。
*   オーラが付いていないGRクリーチャーの破壊（ルールにより）。

## 5. 実装要件 (Implementation Requirements)

### 5.1 PendingEffect構造体
*   `source_id`: 効果発生源のCardID。
*   `effect_type`: 効果の種類 (CIP, AT_ATTACK, SPELL_EFFECT, etc.)。
*   `controller`: 効果の持ち主 (AP/NAP)。

### 5.2 PhaseManager責務
*   各ステップ開始時に `card_db` をスキャンし、該当するトリガー (AT_START_OF_TURN等) を `pending_effects` リストに追加する。
*   `resolve_effects()` 関数で 4.1 のロジックに従いスタックを消化する。

### 5.3 バトル処理
*   `BattleContext` を作成し、攻撃側・防御側のパワーを計算（修正値込み）。
*   結果に基づき `destroy_creature` 等のアクションを発行。
