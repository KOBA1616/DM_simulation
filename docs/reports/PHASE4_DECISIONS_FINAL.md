# Phase 4 逆質問の決定確定 - 最終版

**確定日**: 2026年1月9日  
**ステータス**: ✅ すべての決定完了（Q1-Q9）

---

## 📋 決定内容サマリー

### ✅ Critical（Q1-Q3） - 本日確認済み

| Q | 質問項目 | ユーザー決定 | 実装方針 |
|---|---------|----------|--------|
| **Q1** | Synergy初期化 | **A（手動定義）** | JSON + `from_manual_pairs()` で 10-20 ペア定義 |
| **Q2** | CLSトークン位置 | **A（先頭）** | `[CLS] [GLOBAL] [SEP] ...` の形式 |
| **Q3** | バッチサイズ | **8→16→32→64** | 段階的拡大、推奨値 32（メモリ ~7.2GB） |

---

### ✅ High & Medium（Q4-Q9） - 本日追加決定

| Q | 質問項目 | ユーザー決定 | 実装方針 |
|---|---------|----------|--------|
| **Q4** | データ生成 | **A（新規作成）** | `generate_transformer_training_data.py` で 1000 サンプル生成（Week 2 Day 1） |
| **Q5** | Positional Encoding | **A（学習可能）** | `nn.Parameter(torch.randn(...))` で訓練中に最適化 |
| **Q6** | データ拡張 | **カスタム方式** | Deck 正規化（順序なし）+ Battle 保持（スタック情報重要） |
| **Q7** | 評価指標 | **あると便利まで実装** | vs Random, vs MLP（必須）+ 平均ターン数, 推論時間（便利） |
| **Q8** | デプロイ基準 | **バランス型（B）** | vs MLP ≥ 55% + 推論速度 < 10ms（Week 3 確認） |
| **Q9** | Synergy Matrix | **A（密行列）** | 4MB, GPU 効率的。最適化は Phase 3 以降 |

---

## 🎯 Q6 のカスタム方式の詳細（重要）

### データ拡張戦略

**基本方針**: トークンシーケンスを正規化して、ゲーム的に同一な状態は同一のトークン列に

#### 1️⃣ **山札（Deck）内のカード**
- **現在**: カード順が異なると異なるトークン列
- **正規化後**: カード順を無視（昇順ソート）
- **理由**: 山札の順序はゲーム的に無関係
- **効果**: データ効率向上

**実装例**:
```
Before: [DECK] [Card 3, Card 1, Card 2] [SEP]
After:  [DECK] [Card 1, Card 2, Card 3] [SEP]  ← 同じに正規化
```

#### 2️⃣ **バトルゾーン（Battle Zone）での重なり**
- **保持する情報**: カードが物理的に重なっている（スタック）
- **正規化する情報**: その他のカード順
- **理由**: スタック情報は対戦に影響（攻撃対象の選択等）
- **実装**: スタック構造を明示的に記録

**実装例**:
```
Before: [BATTLE] [Card A, Card B (on Card A), Card C] 
After:  [BATTLE] [Card A [STACK: B], Card C]  ← スタック情報保持
```

#### 3️⃣ **墓地（Graveyard）・その他ゾーン**
- **正規化**: カード順無関係（昇順ソート）
- **理由**: ゲーム的に順序無関係

#### 4️⃣ **空のゾーン（Empty Zones）**
- **実装**: ゾーンセパレータは常に含める
- **形式**: `[ZONE_GRAVE] [ZONE_END]` （カード0枚の場合）
- **理由**: 空であることも重要な情報（相手の状態推測等）
- **❌ しない**: ゾーンの省略

#### 5️⃣ **その他**
- ❌ ドロップアウト: 暫定不要（データ量少なし、Phase 2 検討）
- ❌ ゾーン省略: しない

---

## 🔧 実装スケジュール（確定版）

### Week 2 Day 1（1月13日） - 8時間でのタスク

**午前（2.5h）**: Task 1 - Synergy 手動定義
- [ ] `data/synergy_pairs_v1.json` 作成（4-5 ペア）
- [ ] `SynergyGraph.from_manual_pairs()` 実装
- [ ] `test_synergy_manual.py` ✅

**午後前半（3h）**: Task 2 - データ生成
- [ ] `generate_transformer_training_data.py` 実装
- [ ] 1000 サンプル生成 → `data/training_data.npz`
- [ ] `test_training_data_load.py` ✅

**午後後半（2.5h）**: Task 3 - 訓練スクリプト
- [ ] `train_transformer_phase4.py` 実装
- [ ] `TransformerTrainer` クラス
- [ ] バッチサイズ 8 で 1 epoch 完了

**夕方（0.5h）**: Task 4 - 検証
- [ ] バッチサイズ段階的テスト（8, 16, 32）
- [ ] メモリ使用量記録

### Week 2 Day 2-3（1月14-16日）

- 本格訓練（10 epoch）
- Q7 評価指標実装
- vs Random ≥ 70%, vs MLP ≥ 45% 達成確認

### Week 3（1月20-24日）

- Q8 デプロイ基準確認（vs MLP ≥ 55% 達成）
- 24 時間連続稼働テスト
- デプロイ Go/No-Go 判定

---

## ✨ 重要ポイント

### 1. Q6（データ拡張）の独自方式
ユーザーが定義した「Deck 正規化 + Battle 保持」は、単純な全シャッフルや全省略より効率的です。
- **利点**: ゲーム的に意味のある正規化
- **効果**: データ効率向上 + ノイズ削減

### 2. Q7（評価指標）の「あると便利まで」
vs Random + vs MLP の必須指標に加えて、平均ターン数と推論時間も実装することで、運用時の課題を早期発見できます。

### 3. Q8（デプロイ基準）のバランス型
vs MLP ≥ 55% と推論速度 < 10ms の 2 つの基準だけで判定可能。24 時間テストは推奨ですが、必須ではありません。

### 4. Q4（データなし）の対応
既存トレーニングデータが見つからなかったため、新規生成スクリプトを Week 2 Day 1 に実装する必要があります。→ **3 時間のタスク追加**

---

## 📊 最終ステータス

```
準備完了度: ███████████░ 85%

✅ 完了（実装可能）
  - Q1-Q3: Critical 決定確定
  - Q4-Q9: すべての決定確定
  - 詳細実装計画作成済み

🔨 Week 2 Day 1 で実装予定
  - Synergy 手動定義
  - データ生成パイプライン
  - 訓練スクリプト統合
  - バッチスケーリング検証
```

---

## 📞 次のアクション

### 本日（1月9日）中に
✅ 本ドキュメント確認  
✅ 逆質問の回答確定  
✅ Week 2 Day 1 の準備確認

### 1月13日（Week 2 Day 1）開始時
1. [06_Week2_Day1_Detailed_Plan.md](./06_Week2_Day1_Detailed_Plan.md) を参照
2. Task 1-4 を 8 時間で完了
3. 各チェックポイントで動作確認

---

**確定者**: ユーザー（ichirou）  
**実装担当**: AI Code Generation Agent  
**確定日時**: 2026年1月9日  
**次のマイルストーン**: 2026年1月13日（Week 2 Day 1 開始）
