# GUI ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰

GUIè¡¨ç¤ºç’°å¢ƒãŒãªã„å ´åˆï¼ˆCIç’°å¢ƒã‚„ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ã‚µãƒ¼ãƒãƒ¼ï¼‰ã§ã‚‚GUIé–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶²ç¾…çš„ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹ç’°å¢ƒã®æ§‹ç¯‰æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€PyQt6/PySide6ã®GUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¹ã‚¿ãƒ–ï¼ˆãƒ€ãƒŸãƒ¼å®Ÿè£…ï¼‰ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã§ã€å®Ÿéš›ã®GUIç’°å¢ƒãŒãªãã¦ã‚‚ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  run_pytest_with_pyqt_stub.py              â”‚
â”‚  (ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ)                   â”‚
â”‚  - GUI ã‚¹ã‚¿ãƒ–ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—                   â”‚
â”‚  - pytest ã®èµ·å‹•                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  python/tests/conftest.py                   â”‚
â”‚  - pytest ãŒãƒ†ã‚¹ãƒˆåé›†æ™‚ã«è‡ªå‹•çš„ã«å®Ÿè¡Œ          â”‚
â”‚  - _setup_minimal_gui_stubs() ã«ã‚ˆã‚‹          â”‚
â”‚    æœ€å°é™ã®ã‚¹ã‚¿ãƒ–ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StubFinder + StubLoader (MetaPathFinder)  â”‚
â”‚  - import ãƒ•ãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ                     â”‚
â”‚  - PyQt6/PySide6 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹•çš„æ³¨å…¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dummy Classes (ã‚¹ã‚¿ãƒ–å®Ÿè£…)                  â”‚
â”‚  - DummyQWidget                            â”‚
â”‚  - DummyQMainWindow                        â”‚
â”‚  - DummyQApplication                       â”‚
â”‚  - ãã®ä»–ã® Qt ã‚¯ãƒ©ã‚¹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

### 1. å‰ææ¡ä»¶ã®ç¢ºèª

```bash
# Python ç’°å¢ƒã®ç¢ºèª
python --version  # Python 3.8+ ãŒå¿…è¦

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements-dev.txt
```

### 2. ã‚¹ã‚¿ãƒ“ãƒ³ã‚°ã‚¤ãƒ³ãƒ•ãƒ©ã®æ¤œè¨¼

æœ€åˆã«ã‚¹ã‚¿ãƒ“ãƒ³ã‚°æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š

```bash
# Windows (PowerShell)
python run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_stubbing.py -v

# Linux/Mac
python3 run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_stubbing.py -v
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**
```
[STUB] GUI libraries mocked for headless execution...
[RUN] Starting pytest with args: ['python/tests/gui/test_gui_stubbing.py', '-v']
====== test session starts ======
python/tests/gui/test_gui_stubbing.py::test_gui_libraries_are_stubbed PASSED

[OK] PyQt6 stubbing verified successfully.
====== 1 passed in 0.XX s ======
```

### 3. ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

#### å…¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
python run_pytest_with_pyqt_stub.py
```

#### ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å®Ÿè¡Œ

```bash
# GUIé–¢é€£ã®ãƒ†ã‚¹ãƒˆã®ã¿
python run_pytest_with_pyqt_stub.py python/tests/gui/ -v

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
python run_pytest_with_pyqt_stub.py python/tests/test_your_module.py

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆé–¢æ•°
python run_pytest_with_pyqt_stub.py python/tests/test_your_module.py::test_function_name
```

#### pytest ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨

```bash
# è©³ç´°å‡ºåŠ›
python run_pytest_with_pyqt_stub.py -v

# å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ã¿å†å®Ÿè¡Œ
python run_pytest_with_pyqt_stub.py --lf

# ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
python run_pytest_with_pyqt_stub.py --cov=dm_toolkit --cov-report=html

# ä¸¦åˆ—å®Ÿè¡Œ (pytest-xdist ãŒå¿…è¦)
python run_pytest_with_pyqt_stub.py -n auto
```

## ã‚¹ã‚¿ãƒ“ãƒ³ã‚°ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### 1. import ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚‹å‹•çš„ç½®ãæ›ãˆ

`StubFinder` (MetaPathFinder) ã‚’ä½¿ã£ã¦ã€`PyQt6` ã‚„ `PySide6` ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã‚¹ã‚¿ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿”ã—ã¾ã™ï¼š

```python
# sys.meta_path ã«æŒ¿å…¥ã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼
class StubFinder(importlib.abc.MetaPathFinder):
    def find_spec(self, fullname, path, target=None):
        if fullname in self.mocks:
            return ModuleSpec(fullname, StubLoader(self.mocks[fullname]))
        return None
```

### 2. ãƒ€ãƒŸãƒ¼ã‚¯ãƒ©ã‚¹ã¨æ©Ÿèƒ½çš„ãªã‚·ã‚°ãƒŠãƒ«å®Ÿè£…

å®Ÿéš›ã®GUIã‚¯ãƒ©ã‚¹ã‚’æ¨¡å€£ã—ãŸãƒ€ãƒŸãƒ¼ã‚¯ãƒ©ã‚¹ã¨ã€**æ©Ÿèƒ½çš„ãªã‚·ã‚°ãƒŠãƒ«/ã‚¹ãƒ­ãƒƒãƒˆæ©Ÿæ§‹**ã‚’æä¾›ï¼š

```python
class MockSignal:
    """å®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚·ã‚°ãƒŠãƒ«/ã‚¹ãƒ­ãƒƒãƒˆå®Ÿè£…"""
    def __init__(self):
        self._slots = []
    
    def connect(self, slot):
        self._slots.append(slot)
        return None
    
    def disconnect(self, slot=None):
        if slot is None:
            self._slots.clear()
        elif slot in self._slots:
            self._slots.remove(slot)
        return None
    
    def emit(self, *args, **kwargs):
        # æ¥ç¶šã•ã‚ŒãŸå…¨ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å®Ÿè¡Œ
        for slot in self._slots:
            slot(*args, **kwargs)
        return None

class EnhancedButton(DummyQWidget):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.clicked = MockSignal()  # æ©Ÿèƒ½çš„ãªã‚·ã‚°ãƒŠãƒ«
```

### 3. ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

#### âœ… å®Œå…¨ã«ã‚µãƒãƒ¼ãƒˆ

- **ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯**: `QPushButton.clicked` ã‚·ã‚°ãƒŠãƒ«
- **ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹é¸æŠ**: `QComboBox.currentIndexChanged` ã‚·ã‚°ãƒŠãƒ«
- **ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´**: `QLineEdit.textChanged` ã‚·ã‚°ãƒŠãƒ«
- **ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹**: `QCheckBox.stateChanged` ã‚·ã‚°ãƒŠãƒ«
- **ã‚·ã‚°ãƒŠãƒ«/ã‚¹ãƒ­ãƒƒãƒˆæ¥ç¶š**: `connect()`, `disconnect()`, `emit()`
- **ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚¨ãƒ©ãƒ¼æ¤œå‡º**: try/except ã§ã‚­ãƒ£ãƒƒãƒå¯èƒ½
- **è¤‡æ•°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–“ã®ç›¸äº’ä½œç”¨**: çŠ¶æ…‹ç®¡ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³

#### âš ï¸ éƒ¨åˆ†çš„ã«ã‚µãƒãƒ¼ãƒˆ

- **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**: ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®è¿½åŠ ã¯å¯èƒ½ã ãŒã€å®Ÿéš›ã®é…ç½®è¨ˆç®—ã¯è¡Œã‚ã‚Œãªã„
- **ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆéšå±¤**: è¦ªå­é–¢ä¿‚ã®è¨­å®šã¯å¯èƒ½ã ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¿…è¦

#### âŒ ã‚µãƒãƒ¼ãƒˆå¤–ï¼ˆå®Ÿéš›ã®GUIç’°å¢ƒãŒå¿…è¦ï¼‰

- **è¦–è¦šçš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: ãƒ”ã‚¯ã‚»ãƒ«ãƒ¬ãƒ™ãƒ«ã®æç”»ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
- **å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›**: ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã®ç‰©ç†çš„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—**: `geometry()`, `size()` ã®å®Ÿéš›ã®å€¤
- **ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—**: `QApplication.exec()` ã®å®Ÿè¡Œ

## æ–°ã—ã„GUIãƒ†ã‚¹ãƒˆã®ä½œæˆ

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

```
python/tests/
â”œâ”€â”€ gui/                          # GUIé–¢é€£ã®ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_gui_stubbing.py       # ã‚¹ã‚¿ãƒ“ãƒ³ã‚°æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_gui_interactions.py   # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆä¾‹
â”‚   â”œâ”€â”€ test_your_gui.py           # æ–°ã—ã„GUIãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ __pycache__/
â””â”€â”€ conftest.py                   # å…±é€šè¨­å®šã¨ã‚¹ã‚¿ãƒ–ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```

### ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹

#### åŸºæœ¬çš„ãªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆä½œæˆãƒ†ã‚¹ãƒˆ

```python
# python/tests/gui/test_your_gui.py
import pytest

def test_window_creation():
    """ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒæ­£ã—ãä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ"""
    from PyQt6.QtWidgets import QMainWindow, QWidget
    
    window = QMainWindow()
    central_widget = QWidget()
    window.setCentralWidget(central_widget)
    
    # ã‚¹ã‚¿ãƒ–ç’°å¢ƒã§ã¯ä¾‹å¤–ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
    assert window is not None
    assert central_widget is not None
```

#### ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

```python
def test_button_click():
    """ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ"""
    from PyQt6.QtWidgets import QPushButton
    from unittest.mock import MagicMock
    
    button = QPushButton("Click Me")
    handler = MagicMock()
    
    # ã‚·ã‚°ãƒŠãƒ«æ¥ç¶šï¼ˆã‚¹ã‚¿ãƒ–ã§ã¯ connect ã¯ MagicMockï¼‰
    button.clicked.connect(handler)
    
    # ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    button.clicked.emit()
    
    # ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    handler.assert_called_once()
```

#### ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®é¸æŠãƒ†ã‚¹ãƒˆ

```python
def test_combobox_selection():
    """ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®é¸æŠã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ"""
    from PyQt6.QtWidgets import QComboBox
    from unittest.mock import MagicMock
    
    combo = QComboBox()
    combo.addItem("Option 1", 1)
    combo.addItem("Option 2", 2)
    
    handler = MagicMock()
    combo.currentIndexChanged.connect(handler)
    
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¤‰æ›´
    combo.setCurrentIndex(1)
    combo.currentIndexChanged.emit(1)
    
    # ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ã„å¼•æ•°ã§å‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    handler.assert_called_with(1)
```

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

```python
def test_error_handling_in_handler():
    """ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆ"""
    from PyQt6.QtWidgets import QPushButton
    
    button = QPushButton("Error Test")
    errors = []
    
    def faulty_handler():
        raise ValueError("Test error")
    
    def safe_handler():
        try:
            faulty_handler()
        except ValueError as e:
            errors.append(str(e))
    
    button.clicked.connect(safe_handler)
    button.clicked.emit()
    
    # ã‚¨ãƒ©ãƒ¼ãŒæ­£ã—ãã‚­ãƒ£ãƒƒãƒã•ã‚ŒãŸ
    assert len(errors) == 1
    assert "Test error" in errors[0]
```

#### è¤‡é›‘ãªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–“ã®ç›¸äº’ä½œç”¨ãƒ†ã‚¹ãƒˆ

```python
def test_widget_state_management():
    """è¤‡æ•°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–“ã®çŠ¶æ…‹ç®¡ç†ã‚’ãƒ†ã‚¹ãƒˆ"""
    from PyQt6.QtWidgets import QPushButton, QComboBox
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    class AppState:
        def __init__(self):
            self.mode = "default"
            self.count = 0
        
        def set_mode(self, index):
            self.mode = "mode_a" if index == 0 else "mode_b"
        
        def increment(self):
            self.count += 1
    
    state = AppState()
    
    mode_combo = QComboBox()
    mode_combo.addItem("Mode A", 0)
    mode_combo.addItem("Mode B", 1)
    
    action_button = QPushButton("Execute")
    
    # ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
    mode_combo.currentIndexChanged.connect(state.set_mode)
    action_button.clicked.connect(state.increment)
    
    # æ“ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    mode_combo.setCurrentIndex(1)
    mode_combo.currentIndexChanged.emit(1)
    assert state.mode == "mode_b"
    
    action_button.clicked.emit()
    assert state.count == 1
```

### ã‚¹ã‚¿ãƒ–ã«æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

å¿…è¦ã«å¿œã˜ã¦ `run_pytest_with_pyqt_stub.py` ã® `setup_gui_stubs()` é–¢æ•°ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼š

```python
# run_pytest_with_pyqt_stub.py ã® setup_gui_stubs() å†…
for w in ['QLabel', 'QPushButton', ..., 'YourNewWidget']:
    setattr(qt_widgets, w, type(w, (DummyQWidget,), {}))
```

## CI/CD çµ±åˆ

### GitHub Actions ã®ä¾‹

```yaml
name: Tests with GUI Stubbing

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
      
      - name: Verify GUI stubbing infrastructure
        run: |
          python run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_stubbing.py -v
      
      - name: Run all tests (headless)
        run: |
          python run_pytest_with_pyqt_stub.py --cov=dm_toolkit --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

### GitLab CI ã®ä¾‹

```yaml
test:headless:
  stage: test
  image: python:3.10
  script:
    - pip install -r requirements-dev.txt
    - python run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_stubbing.py -v
    - python run_pytest_with_pyqt_stub.py --cov=dm_toolkit
  coverage: '/TOTAL.*\s+(\d+%)$/'
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: `ImportError: No module named 'PyQt6'`

**åŸå› **: ã‚¹ã‚¿ãƒ“ãƒ³ã‚°ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
1. `run_pytest_with_pyqt_stub.py` ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
2. `test_gui_stubbing.py` ã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¿ãƒ“ãƒ³ã‚°æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

### å•é¡Œ: `AttributeError: module 'PyQt6.QtWidgets' has no attribute 'XXX'`

**åŸå› **: ã‚¹ã‚¿ãƒ–ã«å¿…è¦ãªã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
`run_pytest_with_pyqt_stub.py` ã® `setup_gui_stubs()` ã«å¿…è¦ãªã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼š

```python
qt_widgets.YourMissingClass = type('YourMissingClass', (DummyQWidget,), {})
```

### å•é¡Œ: ãƒ†ã‚¹ãƒˆãŒå®Ÿéš›ã®GUIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã—ã¾ã†

**åŸå› **: ç’°å¢ƒã« PyQt6 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€ã‚¹ã‚¿ãƒ–ã‚ˆã‚Šå…ˆã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹

**è§£æ±ºç­–**:
1. `conftest.py` ã® `_setup_minimal_gui_stubs()` ãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
2. å¿…è¦ã«å¿œã˜ã¦å®Ÿéš›ã® PyQt6 ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

### å•é¡Œ: CIç’°å¢ƒã§ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**åŸå› **: GUIåˆæœŸåŒ–ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹å¯èƒ½æ€§

**è§£æ±ºç­–**:
ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼š
```bash
export QT_QPA_PLATFORM=offscreen
export DISPLAY=:99  # Xvfbä½¿ç”¨æ™‚
```

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒ†ã‚¹ãƒˆã®ç‹¬ç«‹æ€§ã‚’ä¿ã¤

```python
# Good: ãƒ†ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
def test_widget_a():
    widget = QWidget()
    # ãƒ†ã‚¹ãƒˆ...

def test_widget_b():
    widget = QWidget()  # æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    # ãƒ†ã‚¹ãƒˆ...

# Bad: ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’å…±æœ‰
global_widget = QWidget()  # âŒ

def test_widget_a():
    global global_widget
    # ãƒ†ã‚¹ãƒˆ...
```

### 2. ã‚¹ã‚¿ãƒ–ã®é™ç•Œã‚’ç†è§£ã™ã‚‹

ã‚¹ã‚¿ãƒ–ã¯å®Ÿéš›ã®GUIã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æä¾›ã—ã¾ã›ã‚“ï¼š

```python
# âœ… ã‚¹ã‚¿ãƒ–ã§å¯èƒ½ãªã“ã¨
def test_structure():
    """ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆæ§‹é€ ã¨ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ"""
    window = QMainWindow()
    widget = QWidget()
    window.setCentralWidget(widget)
    assert window is not None

def test_event_logic():
    """ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ"""
    button = QPushButton()
    handler = MagicMock()
    button.clicked.connect(handler)
    button.clicked.emit()  # ã‚·ã‚°ãƒŠãƒ«ã‚’æ˜ç¤ºçš„ã«ç™ºç«
    handler.assert_called_once()

def test_state_changes():
    """ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆçŠ¶æ…‹ã®å¤‰æ›´ãƒ†ã‚¹ãƒˆ"""
    combo = QComboBox()
    combo.addItem("Item 1")
    combo.setCurrentIndex(0)
    # ãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œè¨¼ãŒå¯èƒ½

# âŒ ã‚¹ã‚¿ãƒ–ã§ã¯ä¸å¯èƒ½ãªã“ã¨ï¼ˆå®Ÿéš›ã®GUIç’°å¢ƒãŒå¿…è¦ï¼‰
def test_visual_rendering():
    """è¦–è¦šçš„ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¤œè¨¼"""
    window = QMainWindow()
    window.show()
    # ãƒ”ã‚¯ã‚»ãƒ«æ¯”è¼ƒã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¤œè¨¼ãªã© âŒ

def test_real_user_interaction():
    """å®Ÿéš›ã®ãƒã‚¦ã‚¹/ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ"""
    button = QPushButton()
    # QTest.mouseClick(button, Qt.LeftButton) âŒ
    # å®Ÿéš›ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆã¯ä¸å¯

def test_layout_geometry():
    """å®Ÿéš›ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—"""
    widget = QWidget()
    # widget.geometry() ã®å®Ÿéš›ã®å€¤å–å¾— âŒ
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã¯å‹•ä½œã—ãªã„
```

**ã‚¹ã‚¿ãƒ–ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥:**
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆï¼ˆçŠ¶æ…‹ç®¡ç†ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼‰
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‹•ä½œæ¤œè¨¼ï¼ˆemit ã§æ˜ç¤ºçš„ã«ç™ºç«ï¼‰
- âœ… ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆæ§‹é€ ã®æ¤œè¨¼
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
- âŒ è¦–è¦šçš„ãªæ¤œè¨¼ï¼ˆåˆ¥ã®çµ±åˆãƒ†ã‚¹ãƒˆã§å®Ÿæ–½ï¼‰
- âŒ å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆE2Eãƒ†ã‚¹ãƒˆã§å®Ÿæ–½ï¼‰

### 3. ã‚¹ã‚¿ãƒ–å›ºæœ‰ã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã—ãªã„

```python
# Good: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆ
def test_data_processing():
    processor = DataProcessor()
    result = processor.process(data)
    assert result == expected

# Bad: ã‚¹ã‚¿ãƒ–ã®å®Ÿè£…è©³ç´°ã«ä¾å­˜
def test_stub_behavior():
    widget = QWidget()
    assert isinstance(widget, DummyQWidget)  # âŒ ã‚¹ã‚¿ãƒ–ä¾å­˜
```

## ã¾ã¨ã‚

ã“ã®ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆç’°å¢ƒã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã§ãã¾ã™ï¼š

### âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½ãªæ“ä½œ

| æ“ä½œ | ã‚µãƒãƒ¼ãƒˆ | ãƒ†ã‚¹ãƒˆæ–¹æ³• |
|------|---------|-----------|
| **ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯** | âœ… å®Œå…¨ | `button.clicked.emit()` ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ |
| **ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹é¸æŠ** | âœ… å®Œå…¨ | `combo.currentIndexChanged.emit(index)` |
| **ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›** | âœ… å®Œå…¨ | `lineEdit.textChanged.emit(text)` |
| **ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹** | âœ… å®Œå…¨ | `checkbox.stateChanged.emit(state)` |
| **ã‚¨ãƒ©ãƒ¼æ¤œå‡º** | âœ… å®Œå…¨ | try/except ã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ |
| **çŠ¶æ…‹ç®¡ç†** | âœ… å®Œå…¨ | ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–“ã®ç›¸äº’ä½œç”¨ã¨çŠ¶æ…‹å¤‰æ›´ã‚’æ¤œè¨¼ |
| **ã‚·ã‚°ãƒŠãƒ«æ¥ç¶š** | âœ… å®Œå…¨ | `connect()`, `disconnect()` ãŒå®Ÿéš›ã«å‹•ä½œ |
| **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ** | âš ï¸ éƒ¨åˆ†çš„ | æ§‹é€ æ¤œè¨¼ã®ã¿ï¼ˆå®Ÿéš›ã®é…ç½®è¨ˆç®—ãªã—ï¼‰ |
| **è¦–è¦šæ¤œè¨¼** | âŒ ä¸å¯ | ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€ãƒ”ã‚¯ã‚»ãƒ«æ¯”è¼ƒã¯åˆ¥é€”å¿…è¦ |
| **å®ŸUIã‚¤ãƒ™ãƒ³ãƒˆ** | âŒ ä¸å¯ | QTest ã«ã‚ˆã‚‹å®Ÿéš›ã®ã‚¯ãƒªãƒƒã‚¯ã¯ä¸å¯ |

### ğŸ¯ åˆ©ç‚¹

âœ… CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§GUIé–¢é€£ã®ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œ  
âœ… GUIç’°å¢ƒãŒãªã„ã‚µãƒ¼ãƒãƒ¼ã§ã®é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ  
âœ… é«˜é€Ÿãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®Ÿéš›ã®GUIåˆæœŸåŒ–ãŒä¸è¦ï¼‰  
âœ… 98%+ ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¶­æŒ  
âœ… **ãƒœã‚¿ãƒ³ã€ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãªã©ã®æ“ä½œã‚’å®Œå…¨ã«ãƒ†ã‚¹ãƒˆå¯èƒ½**  
âœ… **ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…ã®ã‚¨ãƒ©ãƒ¼ã‚’æ­£ç¢ºã«æ¤œå‡º**

### ğŸ“‹ ãƒ†ã‚¹ãƒˆä¾‹

```python
# ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
def test_button_click():
    button = QPushButton("Click Me")
    handler = MagicMock()
    button.clicked.connect(handler)
    button.clicked.emit()  # ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    handler.assert_called_once()  # âœ… å‘¼ã³å‡ºã—ã‚’æ¤œè¨¼

# ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹é¸æŠã®ãƒ†ã‚¹ãƒˆ
def test_combo_selection():
    combo = QComboBox()
    combo.addItem("Option 1", 1)
    handler = MagicMock()
    combo.currentIndexChanged.connect(handler)
    combo.setCurrentIndex(0)
    combo.currentIndexChanged.emit(0)  # é¸æŠã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    handler.assert_called_with(0)  # âœ… æ­£ã—ã„å¼•æ•°ã§å‘¼ã°ã‚ŒãŸ

# ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã®ãƒ†ã‚¹ãƒˆ
def test_error_handling():
    button = QPushButton()
    errors = []
    def faulty_handler():
        raise ValueError("Error!")
    def safe_handler():
        try:
            faulty_handler()
        except ValueError as e:
            errors.append(str(e))
    button.clicked.connect(safe_handler)
    button.clicked.emit()
    assert len(errors) == 1  # âœ… ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚ŒãŸ
```

**æ¨™æº–çš„ãªå®Ÿè¡Œæ–¹æ³•:**
```bash
# ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python run_pytest_with_pyqt_stub.py

# ã‚¹ã‚¿ãƒ“ãƒ³ã‚°æ¤œè¨¼
python run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_stubbing.py -v

# ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
python run_pytest_with_pyqt_stub.py python/tests/gui/test_gui_interactions.py -v
```

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‚ç…§ã—ã¦ãã ã•ã„ï¼š
- [AGENTS.md](../AGENTS.md) - é–‹ç™ºãƒãƒªã‚·ãƒ¼ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- [run_pytest_with_pyqt_stub.py](../run_pytest_with_pyqt_stub.py) - ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [python/tests/conftest.py](../python/tests/conftest.py) - pytestè¨­å®šã¨ã‚¹ã‚¿ãƒ–ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
