# Command Pipeline Migration — フェーズ2ドキュメント

目的: レガシーの `Action` ベース表現をエディタとエンジンで `Command` パイプラインへ完全に移行するための手順、受け入れ基準、ロールバック手順、モニタリング案。

## 概要
- このフェーズでは主に「Load-Lift Strategy」を実装し、カードの読み込み時に全ての `actions` を `commands` に変換してメモリ上で展開します。
- エディタは `Action` ノードを直接表示せず、`COMMAND` ノードのみを生成します。
- 保存時は原則 `commands` フィールドのみを書き出します（互換モードは開発フラグで制御）。

## 実施手順（開発→ステージ→本番）
1. 開発ブランチで機能を実装・単体テストを追加（現在完了）
2. 統合テスト: 既存カード群（重要なケース数十〜数百）を使って読み込み→再出力テストを実行。差分と動作差分を確認。
3. ステージ環境で UI 検証: 編集フロー、保存、既存ワークフローが壊れていないかを QA が確認。
4. カナリアリリース: 本番の一部環境または限定ユーザーで有効化し、ログを収集。
5. フルロールアウト: 問題なければフラグをデフォルトで有効化。

## 受け入れ基準
- エディタでカードを開くと `actions` ノードが表示されないこと（`commands` のみ）。
- 主要ユースケース（ドロー、プレイ、バッファ操作、MEKRAID 等）が既存の動作と一致することを示す自動テスト群が成功すること。
- 変換不能な legacy action は `WarningCommand`（保存時は `legacy_warning` マーカー）として明確に一覧され、ユーザーがGUI上で修正可能であること。
- 保存時にデフォルトで `commands` のみが書き出されること（互換モードはオプション）。

## ロールバック計画
- 旧フォーマットでの保存を短期間保持するオプションを用意（例: `EDITOR_LEGACY_SAVE=true` 環境変数）。
- 重大障害発見時は機能フラグを無効化して旧コードパスへ即時フォールバック。リリース手順に戻して再デプロイ。
- 事前に移行前カードのスナップショットをバックアップし、問題があればそれを復元して再テスト。

## テレメトリとモニタリング
- 読み込み時に変換が発生したカードの件数、`WarningCommand` の発生頻度を集計（ログ出力 + オプトインの匿名メトリクス）。
- 保存時に `legacy_warning` フラグがついたコマンドの件数をログ。
- UI エラーや例外頻度を APM（例: Sentry）で監視。

## 開発チェックリスト
- [x] `load_data` での自動変換を実装
- [x] `reconstruct_card_data` を `commands` のみ保存するよう更新
- [x] `WarningCommand` を実装し GUI で可視化
- [x] 単体テスト: `tests/unit/test_load_lift_migration.py`
- [ ] 統合テスト群の追加（ケース数を拡大）
- [ ] ステージングでの QA 検証
- [ ] カナリアリリースとメトリクス収集

## コード変更の注意点
- `ActionConverter.convert` は互換性を保つため当面辞書を返す実装を維持する。`ActionConverter.convert_to_objs` / `convert_action_to_objs` を使って段階的にオブジェクトネイティブ化を進める。
- エンジン（C++）側はまだ旧 `Action` を期待する箇所が残る可能性があるため、保存フォーマットとエンジンの受け口の整合を確認すること。

## 推奨次ステップ
1. 統合テストを充実させる（変換の差分チェック、行動シミュレーションでの差分検出）。
2. `ActionConverter` の主要変換ロジックを段階的に `CommandDef` 直接返却に移行（内部 API を安定化させる）。
3. GUI の編集体験改善（CommandEditForm、分岐視覚化など）。

---
ドキュメント作成者: 自動生成 (作業エージェント)
更新日: 2025-12-26
