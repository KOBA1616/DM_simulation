# 要件定義書（整理版）

## 0. 本書の目的
本書は、プロジェクト「DM_simulation（Duel Masters Trading Card Game Simulator with AI）」に関する要件を、実装や実験の進捗に依存しない形で整理し、開発・検証・運用の判断基準を明確化することを目的とする。

## 1. 対象範囲（スコープ）
### 1.1 対象システム
本システムは、デュエル・マスターズ（TCG）を対象とした以下の要素から構成される。

- C++20 によるゲームエンジン（ルール実行、状態遷移、効果解決、探索・並列実行）
- Python によるラッパー/ツール群（学習パイプライン、データ管理、GUI、テスト）
- JSON を中心とするデータ（カード定義、デッキ、シナリオ、ログ等）

### 1.2 対象外（明確な非スコープ）
- 商用製品としての配布・マネタイズ要件
- ネットワーク対戦やサーバ運用（必要に応じて将来検討）
- 公式ルール改定への即時追従を保証する運用要件（追従は目標とするが保証範囲ではない）

## 2. 利用者と利害関係者
- 研究開発者（エンジン/AI/GUI/データを統合して検証する）
- カードデータ編集者（GUIで能力定義を作成し、検証する）
- 評価担当（AIの性能、安定性、再現性を確認する）

## 3. 用語と前提
### 3.1 主要用語
- **Action**: カード効果等を表すレガシー形式の辞書（互換維持対象）
- **GameCommand**: 厳密化された実行コマンド（標準形式）
- **Action→Command変換**: Action から GameCommand に正規化する工程
- **Headless**: GUI無しでテスト・実行する形態（CIやNo-GUI環境を含む）

### 3.2 前提条件
- テキストはUTF-8で管理する（Windows既定コードページに依存しない）
- C++拡張モジュール（dm_ai_module）は、必要な文脈でのみ必須化する

## 4. システムコンテキスト（入出力・境界）
### 4.1 入力
- カード定義: `data/cards.json`
- デッキ/メタ情報: `data/decks/*`, `data/meta_decks.json`
- シナリオ: `data/scenarios/*` または同等のJSON
- 設定: `config/train_config.yaml` 等

### 4.2 出力
- 対戦ログ、解析ログ: `dumps/logs/*`
- 学習済みモデル: `models/*`
- 生成物（ビルド成果物）: `build/*`, `bin/*`

## 5. 機能要件（Functional Requirements）
### FR-1: ゲームルール実行
- ルールに基づく合法手生成と状態遷移を実装すること
- 効果解決はデータ駆動（カード定義のツリー構造）を基本とし、拡張可能であること

### FR-2: 行動表現の標準化（Action→Command）
- Action から GameCommand への変換は、単一の正規入口を経由すること
- 変換規則は単一のソース（変換モジュール）に集約し、アドホックな辞書操作を排除すること

### FR-3: 互換性（レガシーAPI）
- 既存のレガシー呼び出し形態に対し、互換ラッパーを提供すること
- 互換処理や後処理（post-processing）は分散させず、責務分離されたモジュールへ集約すること

### FR-4: AI学習パイプライン
- 自己対戦によりデータを収集し、学習・評価に接続できること
- 推論はバッチ化等により、言語境界（C++/Python）のオーバーヘッドを抑制できること

### FR-5: GUIツール（カードエディタ）
- JSONを直接編集せずに、カードの能力ツリーを作成・編集できること
- 定義の妥当性検証を備え、エンジン仕様と整合すること

### FR-6: テストと検証（Headless含む）
- Headless環境向けの公式スタブ注入経路を提供し、GUI依存を排除してテスト可能であること
- テスト実行は統一ランナーを介して環境差分を最小化すること

## 6. 非機能要件（Non-Functional Requirements）
### NFR-1: 性能
- 対戦シミュレーションは探索や大量自己対戦に耐える性能を持つこと（C++20/並列実行を活用）

### NFR-2: 再現性
- 学習/評価は設定ファイルとログにより再現可能であること

### NFR-3: 保守性
- 変換パイプライン（Action→Command）の入口/責務/規則は一元化し、変更容易性を確保すること
- 互換分岐（legacy_mode等）の散在を避け、専用モジュールへカプセル化すること

### NFR-4: 可搬性
- Windowsを主要対象としつつ、CMakeによりビルド構成が管理されること

### NFR-5: 品質保証
- 自動テストを継続運用し、GUIスタブやテキスト生成などの残課題を段階的に縮減すること

## 7. 制約（Constraints）
- ビルドはCMakeを正とし、生成物（Visual Studioプロジェクト等）を仕様の根拠にしない
- テキスト/設定/データはUTF-8を正とする

## 8. 受入基準（Acceptance Criteria）
- FR-2: Action→Command 変換が単一入口から呼び出され、テストやラッパーでのアドホック変換が残存しない
- FR-6: Headlessテストが統一ランナーで実行可能であり、GUIスタブ検証テストが通過する
- FR-5: カードエディタで主要な能力編集と妥当性検証が可能である

## 9. トレーサビリティ（参照文書）
- README（プロジェクト概要、セットアップ、文字コード方針）
- システムアーキテクチャ概要（C++/Pythonハイブリッド構成、データ駆動カード処理）
- AI System Specifications（学習・推論・進化等の要件）
- Development Policy（変換入口統一、互換処理集約、Headlessテスト方針）

## 10. 変更履歴
- 2026-01-19: ルートのドキュメント/スクリプトを `docs/` および `scripts/` に整理。READMEに移動注記を追加。
- 2026-01-19: テスト実行により `dm_toolkit.gui.i18n` の Enum 取り扱いでエラーを検出。対応タスクを優先化。

## 11. 今後の方針（短期〜中期）
以下は本プロジェクトの短期（1週間〜1ヶ月）〜中期（1〜3ヶ月）での優先方針です。

- 優先対応（短期）
	- テスト阻害要因の解消：`dm_toolkit.gui.i18n` の防御的修正（Enumでない型のスキップ等）を行い、pytestを再実行して回帰を確認する。
	- ルート整理の完了と開発手順の周知：`README.md` に変更点を明記し、開発者へ通知する。

- 継続改善（中期）
	- `Action→Command` パイプラインの全面レビュー：変換入口のカバレッジ確認、古い参照の削除/ラッパー整理。
	- GUIスタブとヘッドレステストの安定化：CIで毎回検証されるよう統合ランナーを整備。
	- ドキュメント整理：`docs/` のアーカイブ方針を定め、古いメモは `archive/docs/` に移行。

## 12. 優先タスク（実行プラン）
以下は優先度順の実行タスクです。各タスクは小さなPRで進め、CI/pytestで確認しながらマージします。

- タスク A: `dm_toolkit.gui.i18n` の堅牢化（優先度: 高）
	- 目的: Enumでないオブジェクトを検出してスキップし、初期化でクラッシュしないようにする。
	- 検証: `python -m pytest -q` が進行すること。
	- 目安: 1日以内に修正→テスト確認。

- タスク B: ルート整理のレビュー & リファクタ（優先度: 中）
	- 目的: 開発者向けの参照を `docs/`/`scripts/` に一本化し、古いファイルをアーカイブまたは削除する。
	- 検証: `git status` に不要なルートファイルが残らないこと。READMEの手順が正しいこと。
	- 目安: 1週間。

- タスク C: `Action→Command` の検証テスト追加（優先度: 中）
	- 目的: 変換の単一入口（`dm_toolkit.action_to_command`）が想定通りに動作することを自動テストで担保する。
	- 検証: ユニットテストで既存のActionサンプルが期待されるGameCommandに変換されること。
	- 目安: 2週間。

- タスク D: CIワークフロー整備（優先度: 低→中）
	- 目的: pytest, mypy, lint を自動実行し、ヘッドレスGUIスタブ検証を含める。
	- 検証: GitHub Actions で main ブランチに対して全チェックが通過すること。
	- 目安: 3〜6週間。

## 13. 合意事項と次回ミーティングの提案
- 本要件書の追記・更新はPRベースで行い、各PRに明確な検証手順（pytestコマンド、再現手順）を付けること。
- 次回方針確認ミーティング（短報告）: 優先タスクAの完了後に実施（目安: 1営業日後）。

---

以上を `docs/requirements/01_Requirements_Definition_JP.md` に追記しました。優先タスクA（`i18n` 修正）を今すぐ実行してよいですか？
