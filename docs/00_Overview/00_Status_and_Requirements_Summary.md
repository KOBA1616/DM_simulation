# 要件定義書 00: ステータスと要件の概要

## 1. プロジェクト概要
**目標:** C++エンジンとPythonバインディングを使用したデュエル・マスターズAI/エージェントシステムの開発。
**現在のフェーズ:** フェーズ5 (汎用エンジン機能と特徴量抽出)
**焦点:** 堅牢性、検証可能性、リスク管理。特に、エンジンの「原子アクション分解」を行い、複雑な効果処理をシンプルかつデータ駆動で扱えるようにリファクタリングする。

## 2. 現在のステータス
*   **エンジン:** `GameState`、`ActionGenerator`、`EffectResolver`を備えたC++20コア。汎用的な効果解決（Effect Buffer, Stack Zone）を実装済み。
*   **進捗:** 基本的な対戦、コスト軽減、ハイパーエナジー、革命チェンジの実装が完了。メタカウンター（コスト0での踏み倒しメタ）も実装・検証済み。**ジャストダイバー実装完了。**
*   **Pythonバインディング:** `pybind11`統合 (`dm_ai_module`)。
*   **AI:** AlphaZeroスタイルのMCTS (`ParallelRunner`) + PyTorch学習 (`train_simple.py`)。
*   **GUI:** Python `tkinter` ベース (`app.py`) および `PyQt6` ベース (`card_editor.py`)。
*   **データ:** JSONベースのカード定義 (`data/cards.json`)。

## 3. 現在の開発段階 (Current Development Stage)
**ステータス:** **GUI機能拡張（コスト軽減UI）完了**

ジャストダイバーの実装に続き、GUIツール（カードエディタ）の機能を大幅に拡張しました。フィルタリング条件の詳細化に加え、**コスト軽減（APPLY_MODIFIER）** 用の動的ラベル更新機能を追加し、効果エディタの使いやすさを向上させました。

## 4. アクティブな要件とタスク (Uncompleted Tasks)

### 4.1. エンジンリファクタリング：原子アクション分解 (完了)
*   **A. MOVE_CARD (完全共通化):** マナチャージ等の実装完了。
*   **B. TAP_CARD / UNTAP_CARD:** 分離済み。
*   **C. SHUFFLE_DECK:** 実装済み。
*   **D. BATTLE_CREATURES:** `RESOLVE_BATTLE` と `BREAK_SHIELD` に分解完了。

#### 2. その他機能拡張のためのアクション (実装完了)
*   **APPLY_MODIFIER (継続的効果):** 実装済み。
*   **REVEAL_CARDS (公開):** 実装済み。
*   **REGISTER_DELAYED_EFFECT (遅延誘発):** スタブ実装済み。
*   **RESET_INSTANCE (初期化):** 実装済み。

### 4.2. GUI & カード効果の拡張 (一部完了)
*   **カード作成補助 (日本語化 & 視覚化):**
    *   **日本語化 (完了):** GUI上のキーワード能力、アクションタイプ、スコープ等を日本語化済み。
    *   **視覚的ビルダ (完了):**
        *   **対象条件 (Filter) (完了):** 文明、種族、コスト範囲、パワー範囲、タップ状態、ブロッカー、進化クリーチャーの指定GUIを追加。
        *   **トリガー条件 (Condition) (完了):** 効果発動条件（マナ武装、シールド枚数など）を設定するGUIを追加。
        *   **アクション詳細 (完了):** コスト軽減 (`APPLY_MODIFIER`) 選択時に、ラベルを「軽減量」「持続ターン」に動的に変更するUIロジックを実装。

### 4.3. 将来の機能バックログ (ユーザー要望)
*   **システム & エンジン:**
    *   ドロー監視、墓地ロジックの拡張。
*   **カードメカニクス:**
    *   [実装済] ジャストダイバー
    *   代替コスト、メテオバーン、NEO進化、ニンジャ・ストライク、ブロック不可、全体除去、攻撃制限、アンチチート、マナ回収、リアニメイト、モード効果。

### 4.6. 実装完了：ジャストダイバー (Just Diver)

#### 1. 概要
「このクリーチャーが出た時、次の自分のターンのはじめまで、相手に選ばれず、攻撃されない」という能力を実装しました。

#### 2. C++ エンジン拡張
*   **CardKeywords:** `just_diver` フラグを追加。
*   **CardInstance:** `turn_played` (プレイされたターン) を記録するフィールドを追加。
*   **TargetUtils:** `is_valid_target` に `GameState` を渡し、ターン経過判定を行うロジックを追加。
    *   自分のターン終了後、相手ターン中も継続し、次の自分のターン開始時に効果が切れるように判定。
*   **EffectResolver:** カードプレイ時に `turn_played` を現在のターン数に設定するように更新。

#### 3. 検証
*   `tests/test_just_diver.py`:
    *   プレイしたターンに相手が選べないことを確認。
    *   次の自分のターン開始以降（または相手の次のターン）に選べるようになることを確認（仕様上の期限切れ動作）。

### 4.7. 実装完了：GUI機能拡張 (フィルタリング & 日本語化)

#### 1. 概要
カードエディタ (`python/gui/card_editor.py`) において、詳細なカード選択条件（フィルタ）をGUI上で設定可能にしました。また、UIの日本語化を推進しました。

#### 2. 実装詳細
*   **localization.py の更新:** アクションタイプ、スコープ、ゾーン、フィルタ項目などの日本語訳を追加。
*   **CardEditor の拡張 (フィルタ):**
    *   **文明 (Civilizations):** 複数選択可能なテキスト入力（カンマ区切り）。
    *   **種族 (Races):** 複数選択可能なテキスト入力。
    *   **コスト・パワー範囲:** 最小値・最大値を指定するスピンボックス（-1で無視）。
    *   **状態フラグ:** 「タップ状態」「ブロッカー」「進化クリーチャー」の有無を「指定なし/はい/いいえ」で選択可能に。
*   **データの永続化:** JSONデータの `FilterDef` 構造体とUIウィジェット間の相互変換ロジックを実装。

#### 3. 検証
*   `tests/verify_card_editor_extensions.py` (検証用一時スクリプト) にて、GUIを持たない環境下でのロジック動作（ロード、編集、保存）が正常であることを確認済み。

### 4.8. 実装完了：GUI機能拡張 (トリガー条件エディタ)

#### 1. 概要
カードエディタ (`python/gui/card_editor.py`) にて、効果の発動条件 (`ConditionDef`) をGUIで編集可能にしました。

#### 2. 実装詳細
*   **ConditionEditor UI:** 効果エディタ内に「Condition」セクションを追加。
    *   **タイプ選択:** `MANA_ARMED` (マナ武装), `SHIELD_COUNT` (シールド枚数), `CIVILIZATION_MATCH` (文明一致), `OPPONENT_PLAYED_WITHOUT_MANA` (踏み倒しメタ) などを選択可能。
    *   **値設定:** 数値 (value) と 文字列 (str_val) を入力可能。
*   **データ連携:** 選択された効果の `condition` フィールドを読み込み・保存するロジックを実装。

#### 3. 検証
*   `tests/verify_condition_editor_logic.py` (検証用一時スクリプト) にて、データのロード・更新・保存ロジックが正常に動作することを確認済み。

## 5. 既知の問題 / リスク
*   **複雑な効果:** 複数ステップの効果 (探索、シールドトリガーの選択) はC++での堅牢な処理が必要です。
*   **メモリ使用量:** `verify_performance.py` でのシミュレーション回数が多いと、メモリアロケーションエラー (`std::bad_alloc`) が発生する可能性があります。
*   **データの一貫性:** `data/cards.csv` はレガシーであり、`data/cards.json` を使用する必要があります。

## 6. 今後の実装計画 (Future Implementation Plan)

### [PLAN-003] Transformerアーキテクチャの実装
*   **概要:** 現在のCNN/ResNetモデルから、Transformer (Self-Attention) モデルへの移行。
*   **目的:** 盤面の複雑な相互作用を捉え、より戦略的な深さを持つAI「自筆進化エコシステム」の基盤とする。

### [PLAN-004] PBT (Population Based Training) 基盤の構築
*   **概要:** 数千〜数万試合規模の並列対戦を実行し、エージェントを進化させるパイプラインの構築。
*   **目的:** メタゲームの変遷に適応する堅牢なAIを作成する。

## 7. 開発規約 (Development Conventions)
*   **コミットメッセージ:** 日本語で記述する。 (`[Type] Subject`)
