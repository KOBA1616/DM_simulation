# Status and Requirements Summary (要件定義書 00)

このドキュメントはプロジェクトの現在のステータス、実装済み機能、および次のステップの要件をまとめたマスタードキュメントです。

本要件定義書はShift-JISで記述することを前提とします（ツール制約によりファイルエンコードはUTF-8で保存されています）。

## 1. 概要 (Overview)

Duel Masters AI Simulatorは、C++による高速なゲームエンジンと、Python/PyTorchによるAlphaZeroベースのAI学習環境を統合したプロジェクトです。
現在、コアエンジンの実装フェーズ（Phase 0: Foundation）を完了し、AIの知能進化と自己学習エコシステムの構築（Phase 1-4）へと移行しています。

## 2. 現行システムステータス (Phase 0: Foundation)

### 2.1 コアエンジン (C++)
*   **基本ルール**: マナチャージ、召喚、攻撃、ブロック、シールドブレイク、勝利条件などの基本ゲームループを実装済み。
*   **高度なメカニクス**:
    *   **スタックシステム**: トリガー能力の待機と解決順序の制御。
    *   **多色・進化**: 多色カードのマナ支払い（バックトラック法）、進化クリーチャー、NEOクリーチャー、メテオバーン。
    *   **アクションシステム**: `GenericCardSystem` と `IActionHandler` によるモジュラーな効果処理。
    *   **効果実装**: サーチ、シールド追加、除去、ハンデス、革命チェンジ、ジャストダイバー、ハイパーエナジーなど。

### 2.2 AI & 学習基盤 (Python/C++)
*   **MCTS**: `dm::ai::MCTS` によるモンテカルロ木探索と並列実行 (`ParallelRunner`)。
*   **AlphaZero**: ResNetベースのニューラルネットワークと自己対戦データ収集パイプライン。
*   **PBT準備**: 複数のエージェントを戦わせる基盤の初期実装。

### 2.3 GUI & ツール (Python/PyQt6)
*   **カードエディタ Ver 2.0**: JSONデータの視覚的な作成・編集、ロジックツリー表示、変数リンク機能。
*   **シミュレーション**: 対戦の観戦、デバッグ機能、シナリオ実行。

### 2.4 特定された課題 (Identified Issues)
現在のコアエンジンにおける致命的な既知の不具合は解消されました。

※ 完了した詳細な実装タスク（Phase 0.5-1, Phase 6-8等）は `docs/00_Overview/99_Completed_Tasks_Archive.md` にアーカイブされています。

---

## 3. 未実装要件と開発ロードマップ (Unimplemented Requirements & Roadmap)

未実装の要件を、開発の依存関係と優先度に基づいて再整理したロードマップです。
AIの学習には「正確なカードデータ」が不可欠であるため、カードエディタの改修（Phase 1.5）を最優先とし、その後にエンジンの機能拡張、AI機能の実装へと進みます。

### 3.1 [Priority: Immediate] Phase 1.5: カードエディタ UI/UX 改善
カードデータの入力効率と表現力を向上させ、複雑なカード（多色、ツインパクトなど）の実装を可能にします。

1.  **多色（マルチカラー）カード実装支援**
    *   **状態**: [完了] (2024/05/17)
    *   **要件**: 単一選択のコンボボックスではなく、複数の文明を選択可能なUIに変更する。
    *   **実装内容**:
        *   `CivilizationSelector` ウィジェットを作成し、`CardEditForm` に統合済み。
        *   文明の複数選択をサポートし、`civilizations` (list) として保存。

2.  **ツインパクトカードの視覚的統合**
    *   **状態**: [完了] (2024/05/25)
    *   **要件**: ツインパクトカードを、一般カードと同じような感覚で、直感的に登録・編集できるようにする。
    *   **実装内容**:
        *   `CardEditForm` に「Is Twinpact?」チェックボックスを追加。
        *   チェック時に呪文側編集フォーム（`SpellSideWidget`）を動的に表示。
        *   スクロールエリアの導入による画面レイアウトの最適化。
        *   JSONデータ構造への `spell_side` のネスト保存に対応。

3.  **キーワード能力とトリガー設定の整理**
    *   **状態**: [完了] (2024/05/17)
    *   **要件**: 「シールドトリガー」の設定がキーワード能力（Keywords）とトリガータイミング（TriggerType）で重複しているため、タイミング側を削除し整理する。
    *   **実装内容**:
        *   `EffectEditForm` の `TriggerType` プルダウンから `S_TRIGGER` を削除済み。
        *   シールドトリガーは `CardEditForm` のキーワード能力チェックボックスで設定する運用に統一。

4.  **アクションタイプ「数字を宣言(選択)」の追加**
    *   **状態**: [完了] (2024/05/17)
    *   **要件**: ガチンコ・ジャッジや特定コスト指定などのために、プレイヤーが数字を宣言するアクションを追加する。
    *   **実装内容**:
        *   アクションタイプ `DECLARE_NUMBER` を `ACTION_UI_CONFIG` に追加。
        *   Min Value (`value1`) と Max Value (`value2`) を設定可能とし、出力値を利用可能に設定。

5.  **未反映アクション・条件・効果のGUI反映**
    *   **状態**: [完了] (2024/05/17)
    *   **要件**: エンジン側（C++）には実装済みだが、エディタの選択肢（GUI）に出てこない項目を選択可能にする。
    *   **実装内容**:
        *   `ACTION_UI_CONFIG` に `RETURN_TO_HAND`, `SEARCH_DECK_BOTTOM`, `REVOLUTION_CHANGE`, `FRIEND_BURST`, `SELECT_NUMBER` 等の実装を確認。
        *   `EffectEditForm` にて `MANA_ARMED`, `CIVILIZATION_MATCH` 等の条件が選択可能であることを確認。

6.  **カードテキスト自動生成機能**
    *   **状態**: [完了] (2024/05/26)
    *   **要件**: 入力されたJSONデータに基づき、プレビュー用の日本語テキストを自動生成する。
    *   **実装内容**:
        *   `CardTextGenerator` クラスを作成し、キーワードや効果定義を自然言語ルールテキストに変換。
        *   `CardEditForm` にテキストプレビューエリアを追加し、リアルタイムで反映。
        *   ツインパクト、各種キーワード、トリガー、アクションの日本語化に対応。

### 3.2 [Priority: High] Phase 1.6: エンジン機能拡張 (Engine Enhancements)
エディタで作成されたデータを正しく処理するためのエンジン側対応。

1.  **ツインパクトカードのスキーマ対応**
    *   **状態**: [完了] (2024/05/25)
    *   **要件**: ツインパクトカードのJSON構造をパースし、クリーチャー/呪文の両方の特性を持てるように `CardDefinition` を拡張、または別カードIDとしての扱いを整備する。
    *   **実装内容**:
        *   `CardDefinition` および `CardData` に `spell_side` (std::shared_ptr) フィールドを追加。
        *   `JsonLoader` に再帰的な読み込みロジックを実装。
        *   Pythonバインディングを更新し、Python側から `card.spell_side` へのアクセスを可能にした。

2.  **キーワード能力付与効果 (`GRANT_KEYWORD`)**
    *   **要件**: 「味方クリーチャーに『ブロッカー』を与える」といった継続的効果の実装。

3.  **敗北判定の遅延（ダイレクトアタック時）**
    *   **要件**: ダイレクトアタック被弾時、即座に敗北せず、ニンジャ・ストライクや革命0トリガーの解決ウィンドウ（リアクション）を挟む処理フローへの変更。

4.  **OpenMP有効化と並列処理最適化**
    *   **要件**: シミュレーション速度向上のため、CMakeでのOpenMP有効化と、スレッドセーフな乱数生成・メモリアクセスの徹底。

### 3.3 [Priority: Medium] Phase 2: 不完全情報の克服（PIMC実装）
AIが「見えない情報」を推論するための機能群。

1.  **自己更新型推論システム**
    *   **要件**: `meta_decks.json` を用いて相手のデッキを推定するロジックの実装。
    *   **機能**: マナ・墓地の公開情報からの確率分布算出と、自己対戦を通じたメタ定義の自動更新。

2.  **PIMC (Perfect Information Monte Carlo) 統合**
    *   **要件**: 推論された複数の「仮想世界」を並列で探索し、統合した最善手を打つアルゴリズムの実装。

### 3.4 [Priority: Long-term] Phase 3: 自己進化エコシステムの構築
人間の介入なしに強くなり続けるための自動化システム。

1.  **AlphaZeroサイクル + PBT (Population Based Training)**
    *   **要件**: 自己対戦(Collect) -> 学習(Train) -> 評価(Evaluate) の完全自動ループ構築。
    *   **機能**: 異なるパラメータを持つエージェント同士のリーグ戦と、世代交代・変異ロジックの実装。
2.  **世代管理とストレージ戦略**
    *   **要件**: モデル(`checkpoints/`)と学習データ(`.npz`)の自動ローテーション・削除機能の実装。

    *   **実装内容**:
        *   **自動ループ**: `RunAlphaZeroCycle.py` (仮) により以下のフローを完全自動化。
            *   `Collect` (自己対戦: 現行最強モデル vs 過去モデル/PBT集団)
            *   `Train` (学習: 収集データを用いたモデル更新)
            *   `Evaluate` (評価: Gatekeeperによる新旧対決と入れ替え判定)
        *   **リーグ戦 (PBT)**:
            *   単一のモデルではなく、複数の異なるハイパーパラメータ（攻撃重視、守備重視、リスク係数 $\alpha$ の違いなど）を持つエージェント群（Population）を維持。
            *   エージェント同士をリーグ戦形式で競わせ、優秀な個体のパラメータを継承・変異させて次世代を作る。
    *   **期待効果**: 寝ている間にPCを稼働させるだけで、AIがメタゲームの偏り（アグロ偏重など）を自律的に修正し、多様な戦術を獲得する。

2.1  **詳細実装仕様: 世代管理システムとストレージ戦略 (Generation Management System)**
    *   PBT（Population Based Training）を見据えた、モデルとデッキの世代管理およびストレージ最適化の要件。
    *   **ディレクトリ構造 (Directory Structure)**:
        ```
        checkpoints/
          ├── production/          # 本番稼働用（現在の最強モデル）
          │    └── best_model.pth
          │
          ├── hall_of_fame/        # 殿堂入り（過去の強力なモデル、評価対戦用）
          │    ├── gen_0010.pth
          │    ├── gen_0050.pth
          │    └── gen_0100.pth
          │
          └── population/          # 進化中の個体群（一時保存、頻繁に入れ替わる）
               ├── agent_01/
               │    ├── gen_0005.pth
               │    └── deck.json
               └── agent_02/ ...
        ```
    *   **世代保持ポリシー (Retention Policy)**:
        *   **最新 (Latest)**: 各エージェントにつき、最新3世代のみ保持。
        *   **殿堂入り (Hall of Fame)**: 対数的間隔 (Gen 1, 2, 4, 8, ...) で永続保存し、多様性を維持する対戦相手として利用。
    *   **ストレージ管理**:
        *   学習データ (.npz) は最新の50万〜100万サンプル（スライディングウィンドウ）のみ保持し、自動削除する `cleanup_old_checkpoints()` を実装する。



### 3.5 [Priority: Future] Phase 4: アーキテクチャ刷新
1.  **Linear Attention / DeepSets 導入**
    *   **要件**: 可変長入力に対応し、推論速度と精度を向上させる新モデルアーキテクチャの導入。

2.  **AIモデル高度化 (PPO + LSTM)**
    *   **要件**: 強化学習手法の高度化。
