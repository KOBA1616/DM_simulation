# Status and Requirements Summary (要件定義書 00)

このドキュメントはプロジェクトの現在のステータス、実装済み機能、および次のステップの要件をまとめたマスタードキュメントです。

本要件定義書はUTF-8で記述することを前提とします。
また、GUI上で表示する文字は基本的に日本語で表記できるようにしてください。

## 1. 概要 (Overview)

Duel Masters AI Simulatorは、C++による高速なゲームエンジンと、Python/PyTorchによるAlphaZeroベースのAI学習環境を統合したプロジェクトです。
現在、Phase 0（基盤構築）、Phase 1（エディタ・エンジン拡張）および Phase 2（不完全情報対応）の主要機能、Phase 3（自己学習エコシステム）のコア実装を完了し、**Phase 4（アーキテクチャ刷新）およびシステム全体の安定化・リファクタリング**へフェーズを移行しています。

Python側のコードベースは `dm_toolkit` パッケージとして再構築され、モジュール性が向上しました。

## 2. 現行システムステータス (Current Status)

### 2.1 コアエンジン (C++ / `src/engine`)
*   **フルスペック実装**: 基本ルールに加え、革命チェンジ、侵略、ハイパーエナジー、ジャストダイバー、ツインパクト、封印（基礎）、呪文ロックなどの高度なメカニクスをサポート済み。
*   **アクションシステム**: `IActionHandler` による完全なモジュラー構造。
    *   **カード移動の統一**: `MOVE_CARD` アクションを導入し、DRAW, ADD_MANA, DESTROYなどの専用アクションを汎用移動ロジックで表現可能にしました。
    *   **条件判定の汎用化**: `COMPARE_STAT` 条件を導入し、「手札枚数がX以上」などの数値比較条件を自由に記述可能にしました。
*   **高速シミュレーション**: OpenMPによる並列化と最適化されたメモリ管理により、秒間数千〜数万試合の自己対戦が可能。
*   **不完全情報探索 (PIMC)**: 推定された世界でのモンテカルロ探索（Determinization）を並列実行可能。

### 2.2 カードエディタ & ツール (`dm_toolkit/gui`)
*   **Card Editor Ver 2.1**: 3ペイン構成（ツリー/プロパティ/プレビュー）、文明別UI装飾、簡易カードプレビュー機能を搭載。
*   **機能**: JSONデータの視覚的編集、ロジックツリー、変数リンク、テキスト自動生成。
*   **検証済み**: 生成されたJSONデータはエンジンで即座に読み込み可能。

### 2.3 AI & 学習基盤 (`dm_toolkit/training`)
*   **AlphaZero Pipeline**: データ収集 -> 学習 -> 評価 の完全自動ループが稼働中。
*   **推論エンジン**: 相手デッキタイプ推定 (`DeckClassifier`) と手札確率推定 (`HandEstimator`) を実装済み。
*   **自己進化**: 遺伝的アルゴリズムによるデッキ改良ロジック (`DeckEvolution`) がC++コアに統合され、高速に動作します。

※ 完了した詳細な実装タスクは `docs/00_Overview/99_Completed_Tasks_Archive.md` にアーカイブされています。

---

## 3. 詳細な開発ロードマップ (Detailed Roadmap)

今後は、システムの堅牢性を高めるリファクタリング、ユーザビリティの向上、およびAIモデルのアーキテクチャ刷新（Transformer）を目指します。

### 3.0 [Priority: Immediate] Refactoring and Stabilization (基盤安定化とリファクタリング)

開発効率と信頼性を向上させるため、以下の修正と機能拡張を最優先で実施します。

1.  **基盤リファクタリング (Fundamental Refactoring)**
    *   **パッケージ構造**: `dm_toolkit` をトップレベルパッケージとして確立し、関連するインポートやパス設定を修正します。
    *   **GUIシミュレーション統合**: GUIの「バッチシミュレーション」機能を `ParallelRunner` バックエンド利用に統一し、コード重複の排除と高速化を図ります。
        *   *ステータス: 実装済み (Caution)*。ParallelRunnerへの統合を行いましたが、大量シミュレーション時のメモリリーク問題 (`std::bad_alloc`) のリスクがあるため、バッチサイズを制限し、GUI上に警告を表示しています。

2.  **重要バグ修正 (Critical Bug Fixes)**
    *   **カード統計テストの失敗 (Card Stats Win Contribution)**: `test_card_stats.py` の `test_card_stats_win_contribution` が失敗する。
        *   *ステータス: 修正済み*。バトル解決時の無限ループ（保留中の効果が削除されないバグ）をC++エンジン側で修正し、テストコード側で勝利後の統計更新処理（`PhaseManager.check_game_over`）を正しく呼び出すように修正しました。

### 3.1 [Priority: High] User Requested Enhancements (ユーザー要望対応)

直近のフィードバックに基づき、ユーザビリティ向上とロジックの汎用化を行います。

1.  **エンジン・ロジック拡張**
    *   **フレンド・バースト実装**: アクションに追加。内部処理用IDを自動割り振りし、ユーザーに意識させずに処理する。
        *   *ステータス: 未着手*。
    *   **ロック能力の汎用化**: `LOCK_SPELL_BY_COST` を「呪文ロック」アクションの派生形として再定義する。
    *   **新規アクション・ロジック追加**:
        *   **呪文を唱えるアクション**: ゾーン（どこから）、コスト、文明を指定して呪文を唱えるアクションを追加。
            *   *ステータス: 実装完了*。`CAST_SPELL` アクションを追加し、手札等からコスト踏み倒しで唱える処理を実装しました。
        *   **クリーチャーを出すアクション**: 召喚扱いではない「出す」処理のアクションを追加。
            *   *ステータス: 実装完了*。`PUT_CREATURE` アクションを追加し、バトルゾーンへの直接配置（召喚酔いあり、CIP誘発）を実装しました。
        *   **キーワード能力付与**: 任意対象にキーワード能力を付与するアクションを追加。
            *   *ステータス: 実装完了*。`GRANT_KEYWORD` アクションとしてGUIおよびエンジンに追加し、キーワードと持続ターン数を設定可能にしました。
        *   **革命チェンジ簡易実装**: 種族指定（マジック・クリーチャー等,条件コスト）などの条件を容易にGUI上で設定できるように対応。
        *   **キーワード能力について**：変数や条件などの設定が必要な能力はチェックボックスで選択時点でGUI上に必要な情報の入力欄を表示してください。
        *   **Move card**:移動元、移動先、条件、フィルタをGUIで設定できるようにしてください。
            *   *ステータス: 実装完了*。`MOVE_CARD` アクションとしてGUIおよびエンジンに追加し、移動先ゾーン（Destination Zone）を選択可能にしました。
        *   

        *   **条件付きシールド・トリガー**: 条件付きでS・トリガーを得る能力の実装方法の確立。
    *   **トリガー・リアクション拡張**: [一部完了]
        *   **ストライク・バック**: `ON_SHIELD_ADD` トリガーを実装し、シールドが手札に加わった際のリアクション（ストライク・バック）に対応しました。
        *   **攻撃時リアクションの条件確認**: 攻撃時に宣言し、解決時に条件を再確認するロジックを実装。
        *   **攻撃中断時の制約**: ニンジャ・ストライクなどの手札誘発は、攻撃クリーチャーが場を離れて攻撃が中断された場合、使用できないように制約を追加しました。
    *   **原子アクションが汎用性高く使用できるか検証**
    *   **GUIの日本語化推進**：アクションの関係からプレビューで日本語テキストを生成できるようにしてください。また、GUI上に表示する文字は基本的に英語ではなく、日本語にするようにしてください。
        *   *ステータス: 進行中*。`CardTextGenerator`を更新し、日本語のアクション・トリガーテキスト生成に対応しました。

2.  **シナリオエディタの機能改善 (Scenario Editor Improvements)**
    *   **ゾーン管理の構造化**: 各ゾーン（Hand, Battle Zone, Mana Zone, Shield Zone, Graveyard）をタブまたはグループで整理し、カードID配列ではなく「カード名のリスト」として管理します。
    *   **カード検索・追加機能**: カード名、文明、コスト、テキストでの検索・フィルタリング機能を実装します。
    *   **ドラッグ＆ドロップ**: 検索結果リストから各ゾーンへ直感的にカードを追加できるようにします。
    *   *ステータス: 未着手*。現状のシナリオエディタは基本的なJSONテキスト編集機能に留まっています。

3.  **カードエディタ GUI 改善 (Card Editor GUI Improvements)**
    *   **多色表示の改善**: 2色以上選択時、単純な混色（紫など）ではなく、グラデーションとして表示する。
        *   *ステータス: 実装完了*。プレビュー表示にて、多色カードの背景をグラデーション（または混合色）で表示するように対応しました。
    *   **レイアウト調整**:
        *   Imageスペースの削除。
        *   マナコストの円表示を左上に移動。
        *   パワー数値を左下に移動。
        *   カード名の下に種族を表示。
        *   カードタイプ表示下部のGenerated Text表示をやめ、キーワード能力および能力表示エリアに変更。
        *   *ステータス: 実装完了*。`CardPreviewWidget` のレイアウトを要求通りに再構築しました。
    *   **ツインパクト対応**:
        *   カードを上下半分に分割表示。
        *   下半分のマナコスト（円）を、下半分エリアの右上に表示。
    *   **ID管理の隠蔽**: GUI上でのカードID表示・編集を廃止し、内部処理のみとすることでユーザーからID管理を隠蔽する。
    *   **日本語化**: GUI上の表示文字を可能な限り日本語で表示する。特に、キーワード能力だけでなく、カードに登録した能力テキストもプレビューおよびGenerated Textで日本語表示されるようにする。
        *   *ステータス: 進行中*。基本的なメニューやEnumの日本語化は `localization.py` で行われていますが、カードテキスト生成やプレビューの完全日本語化は未完了です。
    *   **モード選択機能**: 「3つの中から2回選択する（重複可）」などのモード選択の実装とGUI対応。選択肢のネストを深くし、表記・表示を分かりやすくする。
    *   **Reaction Ability UI**:
        *   ニンジャ・ストライクや革命0トリガーなどの「リアクション（手札誘発）」を編集するための専用フォームの実装。
        *   *ステータス: 未着手*。

4.  **Game Info ウィンドウの整理**
    *   **レイアウト分離**:
        *   **上部**: ゲーム進行操作、必須情報。
        *   **下部**: AI設定、シミュレーション設定。
    *   *ステータス: 未完了*。GUIの再設計が必要です。

### 3.2 [Priority: Medium] Phase 4: アーキテクチャ刷新 (Architecture Update)

1.  **Transformer (Linear Attention) 導入**
    *   **目的**: 盤面のカード枚数が可変であるTCGの特性に合わせ、固定長入力のResNetから、可変長入力を扱えるAttention機構へ移行する。
    *   **計画**: `NetworkV2` として、PyTorchでのモデル定義と、C++側のテンソル変換ロジック（`TensorConverter`）の書き換えを行う。
    *   *ステータス: 未着手*。現在のモデルはResNetベースであり、Attention機構の実装は行われていません。

### 3.3 [Priority: Low] Phase 5: エディタ機能の完成形 (Editor Polish)

AI開発と並行して、エディタの残存課題を解消します。

1.  **Logic Mask (ロジックマスク)**
    *   選択された「トリガー」に対して、意味的に無効な「効果」を選択できないようにGUI側でフィルタリングする機能。
    *   *ステータス: 未着手*。
2.  **Visual Effect Builder**
    *   ロジックツリーをノードグラフ形式で表示・編集できる高度なUI（長期目標）。
    *   *ステータス: 未着手*。
