# Status and Requirements Summary (要件定義書 00)

このドキュメントはプロジェクトの現在のステータス、実装済み機能、および次のステップの要件をまとめたマスタードキュメントです。

本要件定義書はShift-JISで記述することを前提とします（ツール制約によりファイルエンコードはUTF-8で保存されています）。

## 1. 概要 (Overview)

Duel Masters AI Simulatorは、C++による高速なゲームエンジンと、Python/PyTorchによるAlphaZeroベースのAI学習環境を統合したプロジェクトです。
現在、コアエンジンの実装フェーズ（Phase 0: Foundation）を完了し、AIの知能進化と自己学習エコシステムの構築（Phase 1-4）へと移行しています。

## 2. 現行システムステータス (Phase 0: Foundation)

### 2.1 コアエンジン (C++)
*   **基本ルール**: マナチャージ、召喚、攻撃、ブロック、シールドブレイク、勝利条件などの基本ゲームループを実装済み。
*   **高度なメカニクス**:
    *   **スタックシステム**: トリガー能力の待機と解決順序の制御。
    *   **多色・進化**: 多色カードのマナ支払い（バックトラック法）、進化クリーチャー、NEOクリーチャー、メテオバーン。
    *   **アクションシステム**: `GenericCardSystem` と `IActionHandler` によるモジュラーな効果処理。
    *   **効果実装**: サーチ、シールド追加、除去、ハンデス、革命チェンジ、ジャストダイバー、ハイパーエナジーなど。

### 2.2 AI & 学習基盤 (Python/C++)
*   **MCTS**: `dm::ai::MCTS` によるモンテカルロ木探索と並列実行 (`ParallelRunner`)。
*   **AlphaZero**: ResNetベースのニューラルネットワークと自己対戦データ収集パイプライン。
*   **PBT準備**: 複数のエージェントを戦わせる基盤の初期実装。

### 2.3 GUI & ツール (Python/PyQt6)
*   **カードエディタ Ver 2.0**: JSONデータの視覚的な作成・編集、ロジックツリー表示、変数リンク機能。
*   **シミュレーション**: 対戦の観戦、デバッグ機能、シナリオ実行。

### 2.4 特定された課題 (Identified Issues)
現在のコアエンジンにおける致命的な既知の不具合は解消されました。

※ 完了した詳細な実装タスク（Phase 0.5-1, Phase 6-8等）は `docs/00_Overview/99_Completed_Tasks_Archive.md` にアーカイブされています。

---

## 3. 未実装要件と開発ロードマップ (Unimplemented Requirements & Roadmap)

未実装の要件を、開発の依存関係と優先度に基づいて再整理したロードマップです。
AIの学習には「正確なカードデータ」が不可欠であるため、カードエディタの改修（Phase 1.5）を最優先とし、その後にエンジンの機能拡張、AI機能の実装へと進みます。

### 3.1 [Priority: Immediate] Phase 1.5: カードエディタ UI/UX 改善
カードデータの入力効率と表現力を向上させ、複雑なカード（多色、ツインパクトなど）の実装を可能にします。

1.  **多色（マルチカラー）カード実装支援**
    *   **要件**: 単一選択のコンボボックスではなく、複数の文明を選択可能なUIに変更する。
    *   **実装案**:
        *   `QCheckBox` を並べた「カラーパレット型」ウィジェットを実装し、`CardDefinition.civilizations` (vector) にマッピングする。
        *   エディタ上のカードプレビュー背景色を、選択された文明に応じて調整する（2色なら分割orグラデーション、3色以上なら均等分割）。

2.  **ツインパクトカードの視覚的統合**
    *   **要件**: ツインパクトカードを、一般カードと同じような感覚で、直感的に登録・編集できるようにする。
    *   **実装案**:
        *   「ツインパクト」フラグを有効にした際、エディタ画面を上下（または左右）に分割し、クリーチャー側と呪文側の入力フォームを同時に表示する。
        *   カード名は「/」によって2つに分けられ、エディタ上のツリー表示でも直感的にわかるようにすること
        *   内部的には1つのJSONファイル内で `creature_part` と `spell_part` のような構造（または既存フィールドの拡張）として保持する。

3.  **キーワード能力とトリガー設定の整理**
    *   **要件**: 「シールドトリガー」の設定がキーワード能力（Keywords）とトリガータイミング（TriggerType）で重複しているため、タイミング側を削除し整理する。
    *   **実装案**:
        *   `TriggerType` のプルダウンから `S_TRIGGER` を削除（または非表示に）する。
        *   キーワード能力の「S・トリガー」チェックボックスがONの場合、自動的にシールドトリガーとしての挙動（`shield_trigger` フラグ）が設定されるようにする。

4.  **アクションタイプ「数字を宣言(選択)」の追加**
    *   **要件**: ガチンコ・ジャッジや特定コスト指定などのために、プレイヤーが数字を宣言するアクションを追加する。
    *   **実装案**:
        *   アクションタイプ `DECLARE_NUMBER` を追加。
        *   エディタ上で宣言可能な数値の範囲（Min/Max）を設定できるようにする。

5.  **未反映アクション・条件・効果のGUI反映**
    *   **要件**: エンジン側（C++）には実装済みだが、エディタの選択肢（GUI）に出てこない項目を選択可能にする。
    *   **対象例**:
        *   アクション: `RETURN_TO_HAND` (バウンス), `SEARCH_DECK_BOTTOM`, `REVOLUTION_CHANGE` 等の最新アクション。
        *   条件: `MANA_ARMED` などの詳細設定。
        *   `ACTION_UI_CONFIG` 等の定義ファイルを更新し、エンジン側のEnum定義と同期させる。

6.  **カードテキスト自動生成機能**
    *   **要件**: 入力されたJSONデータに基づき、プレビュー用の日本語テキストを自動生成する。
    *   **実装案**: `CardTextGenerator` クラスを作成し、キーワードや効果定義を自然言語ルールテキストに変換して表示する。

### 3.2 [Priority: High] Phase 1.6: エンジン機能拡張 (Engine Enhancements)
エディタで作成されたデータを正しく処理するためのエンジン側対応。

1.  **ツインパクトカードのスキーマ対応**
    *   **要件**: ツインパクトカードのJSON構造をパースし、クリーチャー/呪文の両方の特性を持てるように `CardDefinition` を拡張、または別カードIDとしての扱いを整備する。

2.  **キーワード能力付与効果 (`GRANT_KEYWORD`)**
    *   **要件**: 「味方クリーチャーに『ブロッカー』を与える」といった継続的効果の実装。

3.  **敗北判定の遅延（ダイレクトアタック時）**
    *   **要件**: ダイレクトアタック被弾時、即座に敗北せず、ニンジャ・ストライクや革命0トリガーの解決ウィンドウ（リアクション）を挟む処理フローへの変更。

4.  **OpenMP有効化と並列処理最適化**
    *   **要件**: シミュレーション速度向上のため、CMakeでのOpenMP有効化と、スレッドセーフな乱数生成・メモリアクセスの徹底。

### 3.3 [Priority: Medium] Phase 2: 不完全情報の克服（PIMC実装）
AIが「見えない情報」を推論するための機能群。

1.  **自己更新型推論システム**
    *   **要件**: `meta_decks.json` を用いて相手のデッキを推定するロジックの実装。
    *   **機能**: マナ・墓地の公開情報からの確率分布算出と、自己対戦を通じたメタ定義の自動更新。

2.  **PIMC (Perfect Information Monte Carlo) 統合**
    *   **要件**: 推論された複数の「仮想世界」を並列で探索し、統合した最善手を打つアルゴリズムの実装。

### 3.4 [Priority: Long-term] Phase 3: 自己進化エコシステムの構築
人間の介入なしに強くなり続けるための自動化システム。

1.  **AlphaZeroサイクル + PBT (Population Based Training)**
    *   **要件**: 自己対戦(Collect) -> 学習(Train) -> 評価(Evaluate) の完全自動ループ構築。
    *   **機能**: 異なるパラメータを持つエージェント同士のリーグ戦と、世代交代・変異ロジックの実装。

2.  **世代管理とストレージ戦略**
    *   **要件**: モデル(`checkpoints/`)と学習データ(`.npz`)の自動ローテーション・削除機能の実装。

### 3.5 [Priority: Future] Phase 4: アーキテクチャ刷新
1.  **Linear Attention / DeepSets 導入**
    *   **要件**: 可変長入力に対応し、推論速度と精度を向上させる新モデルアーキテクチャの導入。

2.  **AIモデル高度化 (PPO + LSTM)**
    *   **要件**: 強化学習手法の高度化。
