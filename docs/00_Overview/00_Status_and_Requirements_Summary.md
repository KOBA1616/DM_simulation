# 要件定義書 00: ステータスと要件の概要 (Status and Requirements Summary)

## 1. プロジェクト概要 (Project Overview)
**目標:** C++エンジンとPythonバインディングを使用した、デュエル・マスターズAI/エージェントシステムの開発。
**究極の目標:** 数千〜数万試合規模の並列対戦とPBT (Population Based Training) を通じた「自筆進化エコシステム」の構築。
**現在のフェーズ:** フェーズ5完了・フェーズ6移行期 (Generic Functions Cleanup & Search/Shield Mechanics)
**焦点:** 堅牢性、検証可能性、リスク管理。エンジンの「原子アクション」化による複雑な処理の安定化。

## 2. 現在のステータス (Current Status)
*   **エンジン:** C++20コア (`GameState`, `ActionGenerator`, `EffectResolver`)。汎用効果処理 (`GenericCardSystem`) とスタック処理 (`Stack Zone`) が安定稼働中。
*   **実装済みメカニクス:**
    *   基本バトル、シールドブレイク、S・トリガー。
    *   コスト軽減システム (Active Modifiers)。
    *   ハイパーエナジー (Hyper Energy)。
    *   革命チェンジ (Revolution Change)。
    *   ジャストダイバー (Just Diver)。
    *   メタカウンター (コスト踏み倒しメタ)。
    *   汎用アクション: `COUNT_CARDS`, `APPLY_MODIFIER` (継続効果), `RESET_INSTANCE` 等。
*   **ツール:**
    *   GUIカードエディタ (`python/gui/card_editor.py`): 日本語化対応、詳細フィルタ・条件編集機能、視覚的エフェクトビルダ完備。
    *   データ収集: `collect_training_data.py` (C++ `DataCollector` 使用)。
    *   検証: `verify_performance.py` (並列MCTS)。

## 3. 今後のロードマップと実装計画 (Roadmap & Implementation Plan)

### 【直近】フェーズ 6: サーチとシールド操作 (Search & Shield Handling)
**目標:** 「山札からの探索」と「シールドの追加・焼却」を汎用アクションとして実装し、カードプールの表現力を大幅に向上させる。

#### 実装予定機能 (Planned Features)
1.  **サーチ (Search System):**
    *   **アクション:** `SEARCH_DECK` (または `LOOK_AT_DECK` + `SELECT_FROM_DECK`)。
    *   **処理:** 山札を見る -> 条件に合うカードを選択 -> 手札/バトルゾーン等へ移動 -> **山札をシャッフル**。
    *   **課題:** シャッフル処理の公平性と、選択肢の提示方法（GUIおよびAIアクション空間）。
2.  **シールド操作 (Shield Manipulation):**
    *   **シールド追加:** 山札/手札/墓地からシールド化 (`ADD_SHIELD`)。
    *   **シールド焼却:** ブレイク扱いでないシールドの墓地送り (`SEND_SHIELD_TO_GRAVE`)。
    *   **要件:** S・トリガーのチェック有無をフラグで制御可能にする。

#### テスト項目 (Test Items for Phase 6)
*   **サーチ機能:**
    *   [ ] 山札から指定条件（文明、種族）のカードを正しく抽出できるか。
    *   [ ] 抽出後、残りの山札がシャッフルされているか（順序がランダム化されているか）。
    *   [ ] 対象がない場合（「見つからなかった」）の処理が正しく行われるか。
*   **シールド操作:**
    *   [ ] 山札の一番上がシールドに追加され、シールド枚数が増加するか。
    *   [ ] シールド追加時、最大枚数制限（もしあれば）やイベント発動の有無。
    *   [ ] 効果によるシールド除去（ボルメテウス等）でS・トリガーが発動**しない**ことの確認。

### 【短期】フェーズ 7: 複雑な解決チェーン (Complex Resolution Chains)
**目標:** 複数の効果が連鎖する処理（連鎖、GR召喚、複雑なループ証明など）の基盤強化。

*   **予定:** `EffectBuffer` の活用拡大、割り込み処理の一般化。
*   **テスト:** 効果処理中の別効果の割り込みと、解決順序の厳密なテスト。

### 【中期】フェーズ 8: AIモデルの刷新 (AI Model Refinement)
**目標:** 現在のResNetベースから、Transformer (Self-Attention) アーキテクチャへの移行。

*   **概要:** 盤面のカード間の相互作用（シナジー、コンボ）をAttentionメカニズムで捉える。
*   **計画:**
    *   入力特徴量の再設計（シーケンスデータ化）。
    *   Transformerモデルの実装 (`python/py_ai/agent/transformer_model.py`)。
    *   小規模学習による概念実証。

### 【長期】自筆進化エコシステム (Self-written Evolution Ecosystem)
**目標:** 人手の調整なしに、AI同士の対戦を通じてメタゲームが進化する環境の構築。

*   **PBT (Population Based Training):**
    *   数千〜数万試合の並列実行。
    *   勝者の重みを敗者にコピー・変異させる進化的アルゴリズム。
*   **デッキ生成:**
    *   AIによるデッキ構築・調整機能の統合。

## 4. 未解決タスク・バックログ (Backlog)
*   **システム:**
    *   ドロー操作のフック拡充（引いたカードの確認）。
    *   墓地利用ロジックの汎用化（リアニメイト、墓地回収の汎用アクション化）。
*   **カードメカニクス:**
    *   進化クリーチャー（進化元選択ロジック）。
    *   ゴッド・リンク、サイキック・クリーチャー（超次元）。
    *   ニンジャ・ストライク（相手ターン中の割り込み処理の一般化）。

## 5. 開発規約 (Development Conventions)
*   **言語:** コミットメッセージ、ドキュメント、PRコメントは日本語推奨。
*   **検証:** 新機能追加時は必ず単体テスト (`tests/`) と検証スクリプトを作成すること。
*   **データ:** `data/cards.csv` は廃止。`data/cards.json` を正とする。
