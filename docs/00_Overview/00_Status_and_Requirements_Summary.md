# Status and Requirements Summary (要件定義書 00)

このドキュメントはプロジェクトの現在のステータス、実装済み機能、および次のステップの要件をまとめたマスタードキュメントです。

本要件定義書はUTF-8で記述することを前提とします。
また、GUI上で表示する文字は基本的に日本語で表記できるようにしてください。

## 1. 概要 (Overview)

Duel Masters AI Simulatorは、C++による高速なゲームエンジンと、Python/PyTorchによるAlphaZeroベースのAI学習環境を統合したプロジェクトです。
現在、Phase 0（基盤構築）、Phase 1（エディタ・エンジン拡張）および Phase 2（不完全情報対応）の主要機能、Phase 3（自己学習エコシステム）のコア実装を完了し、**Phase 4（アーキテクチャ刷新）およびシステム全体の安定化・リファクタリング**へフェーズを移行しています。

Python側のコードベースは `dm_toolkit` パッケージとして再構築され、モジュール性が向上しました。

## 2. 現行システムステータス (Current Status)

### 2.1 コアエンジン (C++ / `src/engine`)
*   **フルスペック実装**: 基本ルールに加え、革命チェンジ、侵略、ハイパーエナジー、ジャストダイバー、ツインパクト、封印（基礎）、呪文ロックなどの高度なメカニクスをサポート済み。
*   **アクションシステム**: `IActionHandler` による完全なモジュラー構造。
    *   **カード移動の統一**: `MOVE_CARD` アクションを導入し、DRAW, ADD_MANA, DESTROYなどの専用アクションを汎用移動ロジックで表現可能にしました。
    *   **条件判定の汎用化**: `COMPARE_STAT` 条件を導入し、「手札枚数がX以上」などの数値比較条件を自由に記述可能にしました。
*   **高速シミュレーション**: OpenMPによる並列化と最適化されたメモリ管理により、秒間数千〜数万試合の自己対戦が可能。
*   **不完全情報探索 (PIMC)**: 推定された世界でのモンテカルロ探索（Determinization）を並列実行可能。

### 2.2 カードエディタ & ツール (`dm_toolkit/gui`)
*   **Card Editor Ver 2.1**: 3ペイン構成（ツリー/プロパティ/プレビュー）、文明別UI装飾、簡易カードプレビュー機能を搭載。
*   **機能**: JSONデータの視覚的編集、ロジックツリー、変数リンク、テキスト自動生成。
*   **検証済み**: 生成されたJSONデータはエンジンで即座に読み込み可能。

### 2.3 AI & 学習基盤 (`dm_toolkit/training`)
*   **AlphaZero Pipeline**: データ収集 -> 学習 -> 評価 の完全自動ループが稼働中。
*   **推論エンジン**: 相手デッキタイプ推定 (`DeckClassifier`) と手札確率推定 (`HandEstimator`) を実装済み。
*   **自己進化**: 遺伝的アルゴリズムによるデッキ改良ロジック (`DeckEvolution`) がC++コアに統合され、高速に動作します。

※ 完了した詳細な実装タスクは `docs/00_Overview/99_Completed_Tasks_Archive.md` にアーカイブされています。

---

## 3. 詳細な開発ロードマップ (Detailed Roadmap)

今後は、システムの堅牢性を高めるリファクタリング、ユーザビリティの向上、およびAIモデルのアーキテクチャ刷新（Transformer）を目指します。

### 3.0 [Priority: Immediate] Refactoring and Stabilization (基盤安定化とリファクタリング)

開発効率と信頼性を向上させるため、以下の修正と機能拡張を最優先で実施します。

1.  **基盤リファクタリング (Fundamental Refactoring)**
    *   **パッケージ構造**: `dm_toolkit` をトップレベルパッケージとして確立し、関連するインポートやパス設定を修正します。
    *   **GUIシミュレーション統合**: GUIの「バッチシミュレーション」機能を `ParallelRunner` バックエンド利用に統一し、コード重複の排除と高速化を図ります。
        *   *ステータス: 実装済み (Caution)*。ParallelRunnerへの統合を行いましたが、大量シミュレーション時のメモリリーク問題 (`std::bad_alloc`) のリスクがあるため、バッチサイズを制限し、GUI上に警告を表示しています。

### 3.1 [Priority: High] User Requested Enhancements (ユーザー要望対応)

直近のフィードバックに基づき、ユーザビリティ向上とロジックの汎用化を行います。

1.  **エンジン・ロジック拡張**
    *   **フレンド・バースト実装**: アクションに追加。内部処理用IDを自動割り振りし、ユーザーに意識させずに処理する。
        *   *ステータス: 完了*。`CardKeywords` に `friend_burst` フラグを追加し、`GenericCardSystem` による登場時トリガーの自動生成および `FriendBurstHandler` によるタップ・呪文詠唱ロジックを実装しました。
    *   **ロック能力の汎用化**: `LOCK_SPELL_BY_COST` を「呪文ロック」アクションの派生形として再定義する。
        *   *ステータス: 完了*。`ModifierHandler` に `LOCK_SPELL` モードを実装し、`PassiveEffectSystem` の `CANNOT_USE_SPELLS` と連携させることで汎用化しました。
    *   **新規アクション・ロジック追加**:
        *   **革命チェンジ簡易実装**: 種族指定（マジック・クリーチャー等,条件コスト）などの条件を容易にGUI上で設定できるように対応。
            *   *ステータス: 完了*。`FilterEditorWidget` を拡張し、`CardEditForm` で革命チェンジの条件（種族・コストなど）を直接編集可能にしました。
        *   **キーワード能力について**：変数や条件などの設定が必要な能力はチェックボックスで選択時点でGUI上に必要な情報の入力欄を表示してください。
            *   *ステータス: 完了*。`CardEditForm` のキーワード選択時に、革命チェンジ等のパラメータが必要な能力に対して設定パネルが動的に表示されるようにしました。
        *   **条件付きシールド・トリガー**: 条件付きでS・トリガーを得る能力の実装方法の確立。
            *   *ステータス: 完了*。エンジン（`EffectResolver`）がS・トリガーを確認する際に `TargetUtils` を経由するように変更し、条件判定やパッシブ効果による付与に対応しました。
    *   **トリガー・リアクション拡張**: [一部完了]
        *   **ストライク・バック**: `ON_SHIELD_ADD` トリガーを実装し、シールドが手札に加わった際のリアクション（ストライク・バック）に対応しました。
        *   **攻撃時リアクションの条件確認**: 攻撃時に宣言し、解決時に条件を再確認するロジックを実装。
        *   **攻撃中断時の制約**: ニンジャ・ストライクなどの手札誘発は、攻撃クリーチャーが場を離れて攻撃が中断された場合、使用できないように制約を追加しました。
    *   **原子アクションが汎用性高く使用できるか検証**
        *   *ステータス: 検証済み (一部課題あり)*。
        *   `ActionDef` に `condition` フィールドを追加し、C++エンジンおよびPythonバインディングでサポートしました。
        *   検証スクリプト `tests/verify_atomic_versatility.py` を作成し、条件付きアクション、変数リンク、順次実行のテストケースを実装しました。
        *   しかし、`DestroyHandler` や `DrawHandler` などの既存のC++ハンドラが新しいコンテキスト/条件ロジックを完全には活用できていない課題が確認されました。今後のタスクとしてハンドラの実装更新が必要です。
    *   **GUIの日本語化推進**：アクションの関係からプレビューで日本語テキストを生成できるようにしてください。また、GUI上に表示する文字は基本的に英語ではなく、日本語にするようにしてください。
        *   *ステータス: 完了*。`CardTextGenerator`を更新し、日本語のアクション・トリガーテキスト生成に対応しました。「〜まで選ぶ」等の自然な日本語生成ロジックを追加しました。
    *   ツインパクトカードも左下にパワーを表記する。
    *   カードのテキストを囲う部分の線は文明の色ではなく、黒の細線で良い
    *   マナコストの丸の内部も黒の塗りつぶしではなく、丸と黒字の数字で良い
        *   *ステータス: 完了*。`preview_pane.py` を更新し、要望通りのスタイル（白背景に黒字のマナコスト、黒細線のテキストボックス、ツインパクトパワー表示位置）を実装しました。
    *   ツインパクトカードも上下面でそれぞれ文明を指定できるようにする。
        *   *ステータス: 完了*。`CardEditForm` にスペル側の文明選択ウィジェットを追加し、C++エンジンおよびJSONローダーでの読み込み処理を実装・検証しました。
    *   任意の数字まで行う操作は[n][単位]まで[処理]する。とする。
    *   「ゲーム統計取得」も何を参照しているか示し、「コスト参照処理」も「コスト軽減する」のようにする。
        *   *ステータス: 完了*。`LogicTreeWidget` (via `CardDataManager`) の表示テキストロジックを更新し、「Reference [Stat]」や「Reduce Cost by [Val]」のような親切な表示に対応しました。
        *   このターン引いたカードの枚数分、このクリーチャーを召喚するコストを軽減する　効果をアクションの組み合わせで実現したい。
            *   *ステータス: 完了*。C++エンジンに `ModifierHandler` を実装し、`APPLY_MODIFIER` (Mode: COST) アクションと変数リンクを組み合わせることでコスト軽減を実現可能にしました。
        *   GUIのバトルゾーンの右端にデッキを置く
            *   *ステータス: 完了*。メインウィンドウのバトルゾーン右側にデッキ置き場（ZoneWidget）を追加しました。初期状態では非表示になっています。
        *   シナリオエディタでも使用デッキをそれぞれ指定する。
            *   *ステータス: 完了*。シナリオエディタに「My Deck」「Enemy Deck」タブを追加し、JSON形式のデッキファイルを直接ロードできるようにしました。
        *   シナリオエディタ内で検索するときは登録したデッキ内から検索し、設定したデッキ内からカードを配置することで総量40枚一定にする。
            *   *ステータス: 完了*。デッキタブ内に「Search & Move to Zone」機能を追加し、デッキ内のカードを選択して手札・マナ・バトルゾーン等へ移動させる機能（同時にデッキから削除）を実装しました。

2.  **カードエディタ GUI 改善 (Card Editor GUI Improvements)**
    *   **ID管理の隠蔽**: GUI上でのカードID表示・編集を廃止し、内部処理のみとすることでユーザーからID管理を隠蔽する。
        *   *ステータス: 完了*。カード編集フォームからIDフィールドを非表示にしました。
    *   **日本語化**: GUI上の表示文字を可能な限り日本語で表示する。特に、キーワード能力だけでなく、カードに登録した能力テキストもプレビューおよびGenerated Textで日本語表示されるようにする。
        *   *ステータス: 完了*。`localization.py` を大幅に更新し、新しいGUI要素（リアクション、フィルタ等）の日本語化を完了しました。
    *   **モード選択機能**: 「3つの中から2回選択する（重複可）」などのモード選択の実装とGUI対応。選択肢のネストを深くし、表記・表示を分かりやすくする。
        *   *ステータス: 未着手*。ネストされたアクションのGUI実装とエンジン対応は次フェーズの課題とします。
    *   **Reaction Ability UI**:
        *   ニンジャ・ストライクや革命0トリガーなどの「リアクション（手札誘発）」を編集するための専用フォームの実装。
        *   *ステータス: 完了*。`ReactionWidget` を新規作成し、`CardEditForm` に統合しました。

### 3.2 [Priority: Medium] Phase 4: アーキテクチャ刷新 (Architecture Update)

1.  **Transformer (Linear Attention) 導入**
    *   **目的**: 盤面のカード枚数が可変であるTCGの特性に合わせ、固定長入力のResNetから、可変長入力を扱えるAttention機構へ移行する。
    *   **計画**: `NetworkV2` として、PyTorchでのモデル定義と、C++側のテンソル変換ロジック（`TensorConverter`）の書き換えを行う。
    *   *ステータス: 着手*。`dm_toolkit/training/network_v2.py` を作成し、O(N)計算量の `LinearAttention` およびTransformerベースの `NetworkV2` クラスの初期実装を行いました。

### 3.3 [Priority: Low] Phase 5: エディタ機能の完成形 (Editor Polish)

AI開発と並行して、エディタの残存課題を解消します。

1.  **Logic Mask (ロジックマスク)**
    *   選択された「トリガー」に対して、意味的に無効な「効果」を選択できないようにGUI側でフィルタリングする機能。
    *   *ステータス: 未着手*。
