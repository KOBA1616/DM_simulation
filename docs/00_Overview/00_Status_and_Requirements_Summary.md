# 要件定義書 00: ステータスと要件の概要

## 1. プロジェクト概要
**目標:** C++エンジンとPythonバインディングを使用したデュエル・マスターズAI/エージェントシステムの開発。
**現在のフェーズ:** フェーズ5 (汎用エンジン機能と特徴量抽出)
**焦点:** 堅牢性、検証可能性、リスク管理。

## 2. 現在のステータス
*   **エンジン:** `GameState`、`ActionGenerator`、`EffectResolver`を備えたC++20コア。
*   **Pythonバインディング:** `pybind11`統合 (`dm_ai_module`)。
*   **AI:** AlphaZeroスタイルのMCTS (`ParallelRunner`) + PyTorch学習 (`train_simple.py`)。
*   **GUI:** Python `tkinter` ベース (`app.py`, `card_editor.py`) ※注: `card_editor.py`はPyQt6ベースに変更されています。
*   **データ:** JSONベースのカード定義 (`data/cards.json`)。

## 3. アクティブな要件とタスク (Uncompleted Tasks)

### 3.1. GUI & カード効果の拡張
*   **山札の上を見る (改善):**
    *   **非公開 vs 公開:** 非公開情報 (実行者のみ) と公開情報 (両プレイヤー) の区別を視覚化する必要があります。*実装メモ: `SEARCH_DECK_BOTTOM` はロジックを処理しますが、フロントエンドでの「公開された」カードの視覚化には検証が必要です。*
*   **カード作成補助 (日本語化 & 視覚化):**
    *   **日本語化:** GUI上のキーワード能力や汎用能力の選択を日本語で行えるようにする。
    *   **視覚的ビルダ:** トリガー条件、対象ゾーン、処理（見る、表向きにする、手札に戻す、参照など）、対象数、対象条件、コスト軽減などを視覚的に選択・組み合わせて複雑な効果を実装できる機能を追加する。

### 3.2. コア機能の改善
*   **パフォーマンス:** ループ検出と重いロジックをC++に移行 (進行中)。

### 3.3. 開発中の汎用エンジン機能 (PLAN-002残り)

#### 革命チェンジとハイパーエナジー
*   **革命チェンジ:**
    *   専用アクション `REVOLUTION_CHANGE` と、トリガー `ON_ATTACK_FROM_HAND` を新設。(Basic Logic Implemented)
    *   条件に汎用 `FilterDef` を使用し、GUIから設定可能にする。(Partially Implemented)
*   **ハイパーエナジー:** (実装完了 - Verification Needed)
    *   「1体タップしてプレイ」「2体タップしてプレイ」などのパターンをそれぞれ独立したアクションとして生成する。
    *   AIは単一のポリシー出力でコスト支払い方法を選択可能にする。(Action target encoding実装済み)

#### その他機能統合
*   **ゾーン移動の完全統合 (`MOVE_CARD`):** `DESTROY`, `RETURN_TO_HAND`, `SEND_TO_MANA`, `DRAW_CARD` 等を統合。
*   **継続的効果の汎用化 (`APPLY_MODIFIER`):** パワー修正とキーワード能力付与（期間指定、対象指定）を統合。
*   **サーチ系の統合:** `SEARCH_DECK_BOTTOM` を上記エフェクトバッファを用いた原子アクションの組み合わせに分解。

### 3.4. 将来の機能バックログ (ユーザー要望)
*   **システム & エンジン:**
    *   **ドロー監視:** 各ターンでのドロー枚数の監視。
    *   **バトルゾーンチェック:** バトルゾーンの特定コストを参照する機能。
    *   **墓地ロジック:** 「墓地に置かれた時、バトルゾーンにあれば...」 (墓地に置かれた時、バトルゾーン(進化元含む)にあれば...)。
*   **カードメカニクス:**
    *   **ジャストダイバー:** 選ばれない/攻撃されない (ジャストダイバー)。
    *   **代替コスト:** G・ゼロ、シンパシーなど (代替コスト)。
    *   **メテオバーン:** 進化元コスト (メテオバーン)。
    *   **NEO進化:** クリーチャー/進化ハイブリッド (NEO進化)。
    *   **ニンジャ・ストライク:** (ニンジャ・ストライク)。
    *   **ブロック不可 (一時的):** 攻撃時ブロック禁止効果の実装(効果期限)。
    *   **全体除去:** 盤面リセット (全体除去)。
    *   **攻撃制限:** (攻撃制限)。
    *   **アンチチート (メタ):** コスト踏み倒しメタ (踏み倒しメタ)。
    *   **マナ回収:** (マナ回収)。
    *   **リアニメイト:** (蘇生)。
    *   **モード効果:** N個から1つ選択 (モード)。
*   **ツール:**
    *   **GUI拡張:** カード作成GUIの拡張 (視覚的な効果ビルダの実装)。

## 4. 既知の問題 / リスク
*   **複雑な効果:** 複数ステップの効果 (探索、シールドトリガーの選択) はC++での堅牢な処理が必要です。
*   **メモリ使用量:** `verify_performance.py` でのシミュレーション回数が多いと、メモリアロケーションエラー (`std::bad_alloc`) が発生する可能性があります。小規模 (sims=2) での検証は通過します。
*   **データの一貫性:** `data/cards.csv` はレガシーであり、`data/cards.json` とは異なります (特にID 2と3)。新規開発は厳密に `cards.json` に依存する必要があります。

## 5. 今後の実装計画 (Future Implementation Plan)

### [PLAN-003] Transformerアーキテクチャの実装
*   **概要:** 現在のCNN/ResNetモデルから、Transformer (Self-Attention) モデルへの移行。
*   **目的:** 盤面の複雑な相互作用を捉え、より戦略的な深さを持つAI「自筆進化エコシステム」の基盤とする。
*   **詳細:** 入力シーケンスの設計と、PyTorch側のモデル定義の更新。

### [PLAN-004] PBT (Population Based Training) 基盤の構築
*   **概要:** 数千〜数万試合規模の並列対戦を実行し、エージェントを進化させるパイプラインの構築。
*   **目的:** メタゲームの変遷に適応する堅牢なAIを作成する。
*   **要件:** 並列実行時のメモリリーク問題（`std::bad_alloc`）の完全な解決が必要。

## 6. 開発規約 (Development Conventions)

### 6.1. コミットメッセージ
*   **言語:** コミットメッセージは**日本語**で記述する。
*   **目的:** 開発者の意図を明確かつ正確に記録するため。
*   **形式:** `[Type] Subject`
    *   例: `[Feat] 汎用ターゲット選択機能の実装`
    *   例: `[Fix] マナ支払いの計算ロジックを修正`
