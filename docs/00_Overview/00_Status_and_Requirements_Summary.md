# 要件定義書 00: ステータスと要件の概要

## 1. プロジェクト概要
**目標:** C++エンジンとPythonバインディングを使用したデュエル・マスターズAI/エージェントシステムの開発。
**現在のフェーズ:** フェーズ5 (汎用エンジン機能と特徴量抽出)
**焦点:** 堅牢性、検証可能性、リスク管理。

## 2. 現在のステータス
*   **エンジン:** `GameState`、`ActionGenerator`、`EffectResolver`を備えたC++20コア。
*   **Pythonバインディング:** `pybind11`統合 (`dm_ai_module`)。
*   **AI:** AlphaZeroスタイルのMCTS (`ParallelRunner`) + PyTorch学習 (`train_simple.py`)。
*   **GUI:** Python `tkinter` ベース (`app.py`, `card_editor.py`) ※注: `card_editor.py`はPyQt6ベースに変更されています。
*   **データ:** JSONベースのカード定義 (`data/cards.json`)。

### 2.1. 実装済み機能 (最近)
*   **スピードアタッカー / 進化ロジック:** `スピードアタッカー`や`進化`を持つクリーチャーが（召喚酔いを無視して）即座に攻撃できるようにエンジンを修正しました。`verify_lethal_puzzle.py`で検証済み。
*   **バウンス (手札に戻す):** C++エンジンおよびGUIテンプレートで`RETURN_TO_HAND`アクションタイプを実装しました。
*   **デッキ探索/確認:** `SEARCH_DECK_BOTTOM` (上からN枚見て、選択したものを手札に加え、残りを一番下に戻す) を実装しました。
*   **メクレイド:** `MEKRAID` (上から3枚見て、条件に合うものを出し、残りを一番下に戻す) を実装しました。
*   **GUIエディタ:** `card_editor.py`を更新し、上記効果のテンプレートを追加しました。
*   **一貫性のあるJSONデータ:** ユニットテストが通過するように、必須のテストカード (デーモン・ハンド、スパイラル・ゲート) を`data/cards.json`に追加しました。
*   **EffectResolverのリファクタリング:** 呪文およびシールドトリガーの効果解決において`GenericCardSystem`を優先的に使用するように`EffectResolver`をリファクタリングし、コードの重複を削減しました。
*   **汎用ターゲット選択の修正:** `ActionGenerator`が`SELECT_TARGET`アクションを正しく処理し、ターゲット選択後に`RESOLVE_EFFECT`アクションを生成するように修正しました。また、`PendingEffect`がアクション定義を保持するように改善しました。

## 3. 要件 (アクティブ)

### 3.1. 汎用エンジン機能 (実装済み/テスト済み)
*   **汎用ターゲット選択:**
    *   **ステータス:** 実装済み。`tests/manual/test_generic_targeting.py` で検証完了。`SELECT_TARGET` -> `RESOLVE_EFFECT` のフローが正常に動作します。
*   **汎用アクション:**
    *   **ステータス:** `TAP`、`UNTAP`、`DESTROY`、`RETURN_TO_HAND` が `GenericCardSystem` に実装済み。
*   **Pythonバインディング:** `FilterDef` と `ActionDef` をサポートするように更新されました。

### 3.2. GUI & カード効果の拡張
*   **山札の上を見る (改善):**
    *   **非公開 vs 公開:** 非公開情報 (実行者のみ) と公開情報 (両プレイヤー) の区別を視覚化する必要があります。*実装メモ: `SEARCH_DECK_BOTTOM` はロジックを処理しますが、フロントエンドでの「公開された」カードの視覚化には検証が必要です。*
*   **カード作成補助 (日本語化 & 視覚化):**
    *   **日本語化:** GUI上のキーワード能力や汎用能力の選択を日本語で行えるようにする。
    *   **視覚的ビルダ:** トリガー条件、対象ゾーン、処理（見る、表向きにする、手札に戻す、参照など）、対象数、対象条件、コスト軽減などを視覚的に選択・組み合わせて複雑な効果を実装できる機能を追加する。

### 3.3. コア機能 (既存)
*   **ループ検出:** 無限ループを防ぐためのハッシュベースの状態追跡 (実装済み)。
*   **パフォーマンス:** ループ検出と重いロジックをC++に移行 (進行中)。
*   **データ駆動:** すべてのカードロジックにJSONを使用。

### 3.4. 汎用エンジン機能 (新規 - 開発優先)
エンジンの修正なしでより幅広いカード効果をサポートするため、以下の汎用機能を実装します:

*   **一般化されたターゲット選択:**
    *   **完了:** `ActionType::SELECT_TARGET` フローの実装と修正が完了しました。

*   **一般化されたタップ/アンタップ:**
    *   **完了:** `TAP` / `UNTAP` 効果アクションタイプの実装完了。

*   **コスト軽減システム:**
    *   **完了:** `CostModifier` 構造体と `ManaSystem` への統合が完了しました。`tests/test_cost_modifier.py` で検証済み。
    *   **コンポーネント:**
        *   `CostModifier` 構造体: `{ condition, reduction_amount, turn_limit, valid_cards_filter }`。
        *   `GameState.active_modifiers`: アクティブな修正のリスト。
        *   `ManaSystem.get_cost(card)`: 修正を適用して最終コストを計算 (最小コスト1)。

### 3.5. 将来の機能バックログ (ユーザー要望)
*   **システム & エンジン:**
    *   **ドロー監視:** 各ターンでのドロー枚数の監視。
    *   **バトルゾーンチェック:** バトルゾーンの特定コストを参照する機能。
    *   **墓地ロジック:** 「墓地に置かれた時、バトルゾーンにあれば...」 (墓地に置かれた時、バトルゾーン(進化元含む)にあれば...)。
*   **カードメカニクス:**
    *   **ジャストダイバー:** 選ばれない/攻撃されない (ジャストダイバー)。
    *   **代替コスト:** G・ゼロ、シンパシーなど (代替コスト)。
    *   **メテオバーン:** 進化元コスト (メテオバーン)。
    *   **NEO進化:** クリーチャー/進化ハイブリッド (NEO進化)。
    *   **ニンジャ・ストライク:** (ニンジャ・ストライク)。
    *   **ブロック不可 (一時的):** 攻撃時ブロック禁止効果の実装(効果期限)。
    *   **全体除去:** 盤面リセット (全体除去)。
    *   **攻撃制限:** (攻撃制限)。
    *   **アンチチート (メタ):** コスト踏み倒しメタ (踏み倒しメタ)。
    *   **マナ回収:** (マナ回収)。
    *   **リアニメイト:** (蘇生)。
    *   **モード効果:** N個から1つ選択 (モード)。
*   **ツール:**
    *   **GUI拡張:** カード作成GUIの拡張 (視覚的な効果ビルダの実装)。

## 4. 既知の問題 / リスク
*   **複雑な効果:** 複数ステップの効果 (探索、シールドトリガーの選択) はC++での堅牢な処理が必要です。
*   **メモリ使用量:** `verify_performance.py` でのシミュレーション回数が多いと、メモリアロケーションエラー (`std::bad_alloc`) が発生する可能性があります。小規模 (sims=2) での検証は通過します。
*   **データの一貫性:** `data/cards.csv` はレガシーであり、`data/cards.json` とは異なります (特にID 2と3)。新規開発は厳密に `cards.json` に依存する必要があります。

## 5. 今後の実装計画 (Future Implementation Plan)

参照性を高めるため、以下のステップ順に実装を進めます。

### [PLAN-001] コスト軽減システムの実装
*   **概要:** `CostModifier` 構造体と `ManaSystem` への統合。
*   **目的:** シンパシーやコッコ・ルピア等のコスト軽減カードを実装可能にする。
*   **ステータス:** 完了 (Verified).

### [PLAN-002] フェーズ5完了: C++特徴量抽出
*   **概要:** `GameState` から直接ニューラルネットワークの入力テンソル（`std::vector<float>`）を生成する機能をC++側に実装する。
*   **目的:** MCTSシミュレーションにおけるPython/C++間のコンテキストスイッチによるボトルネックを解消し、学習・推論を高速化する。
*   **検証:** Python実装とC++実装の出力が一致することを確認するテストを作成する。

### [PLAN-003] Transformerアーキテクチャの実装
*   **概要:** 現在のCNN/ResNetモデルから、Transformer (Self-Attention) モデルへの移行。
*   **目的:** 盤面の複雑な相互作用を捉え、より戦略的な深さを持つAI「自筆進化エコシステム」の基盤とする。
*   **詳細:** 入力シーケンスの設計と、PyTorch側のモデル定義の更新。

### [PLAN-004] PBT (Population Based Training) 基盤の構築
*   **概要:** 数千〜数万試合規模の並列対戦を実行し、エージェントを進化させるパイプラインの構築。
*   **目的:** メタゲームの変遷に適応する堅牢なAIを作成する。
*   **要件:** 並列実行時のメモリリーク問題（`std::bad_alloc`）の完全な解決が必要。

## 6. 開発規約 (Development Conventions)

### 6.1. コミットメッセージ
*   **言語:** コミットメッセージは**日本語**で記述する。
*   **目的:** 開発者の意図を明確かつ正確に記録するため。
*   **形式:** `[Type] Subject`
    *   例: `[Feat] 汎用ターゲット選択機能の実装`
    *   例: `[Fix] マナ支払いの計算ロジックを修正`
