# Status and Requirements Summary (要件定義書 00)

このドキュメントはプロジェクトの現在のステータス、実装済み機能、および次のステップの要件をまとめたマスタードキュメントです。

本要件定義書はUTF-8で記述することを前提とします

## 1. 概要 (Overview)

Duel Masters AI Simulatorは、C++による高速なゲームエンジンと、Python/PyTorchによるAlphaZeroベースのAI学習環境を統合したプロジェクトです。
現在、Phase 0（基盤構築）、Phase 1（エディタ・エンジン拡張）および Phase 2（不完全情報対応）の主要機能、Phase 3（自己学習エコシステム）のコア実装を完了し、**Phase 4（アーキテクチャ刷新）およびシステム全体の安定化・リファクタリング**へフェーズを移行しています。

Python側のコードベースは `dm_toolkit` パッケージとして再構築され、モジュール性が向上しました。

## 2. 現行システムステータス (Current Status)

### 2.1 コアエンジン (C++ / `src/engine`)
*   **フルスペック実装**: 基本ルールに加え、革命チェンジ、侵略、ハイパーエナジー、ジャストダイバー、ツインパクト、~~オレガ・オーラ（基礎）~~、封印（基礎）、呪文ロックなどの高度なメカニクスをサポート。
*   **アクションシステム**: `IActionHandler` による完全なモジュラー構造。
*   **高速シミュレーション**: OpenMPによる並列化と最適化されたメモリ管理により、秒間数千〜数万試合の自己対戦が可能。
*   **不完全情報探索 (PIMC)**: 推定された世界でのモンテカルロ探索（Determinization）を並列実行可能。

### 2.2 カードエディタ & ツール (`dm_toolkit/gui`)
*   **Card Editor Ver 2.1**: 3ペイン構成（ツリー/プロパティ/プレビュー）、文明別UI装飾、簡易カードプレビュー機能を搭載。
*   **機能**: JSONデータの視覚的編集、ロジックツリー、変数リンク、テキスト自動生成。
*   **検証済み**: 生成されたJSONデータはエンジンで即座に読み込み可能。

### 2.3 AI & 学習基盤 (`dm_toolkit/training`)
*   **AlphaZero Pipeline**: データ収集 -> 学習 -> 評価 の完全自動ループが稼働中。
*   **推論エンジン**: 相手デッキタイプ推定 (`DeckClassifier`) と手札確率推定 (`HandEstimator`) を実装済み。
*   **自己進化**: 遺伝的アルゴリズムによるデッキ改良ロジック (`DeckEvolution`) がC++コアに統合され、高速に動作します。

※ 完了した詳細な実装タスクは `docs/00_Overview/99_Completed_Tasks_Archive.md` にアーカイブされています。

---

## 3. 詳細な開発ロードマップ (Detailed Roadmap)

今後は、システムの堅牢性を高めるリファクタリング、ユーザビリティの向上、およびAIモデルのアーキテクチャ刷新（Transformer）を目指します。

### 3.0 [Priority: Immediate] Refactoring and Stabilization (基盤安定化とリファクタリング)

開発効率と信頼性を向上させるため、以下の修正と機能拡張を最優先で実施します。

1.  **基盤リファクタリング (Fundamental Refactoring)**
    *   **文明データの型安全化 (Civilization Type Safety)**: 現在、文明データはJSON/Python層で文字列（"FIRE" 等）として扱われており、大文字・小文字の不一致による予期せぬバグ（ゼロ文明化）の原因となっています。データレイヤーにおいて文字列ではなくEnumまたは整数IDとして扱うようにリファクタリングを検討します。
    *   **UTF-8 統一**: ソースコードおよびドキュメントのエンコーディングをUTF-8に統一し、Shift-JIS環境依存を解消します。
    *   **パッケージ構造**: `dm_toolkit` をトップレベルパッケージとして確立し、関連するインポートやパス設定を修正します。
    *   **GUIシミュレーション統合**: GUIの「バッチシミュレーション」機能を `ParallelRunner` バックエンド利用に統一し、コード重複の排除と高速化を図ります。

2.  **重要バグ修正 (Critical Bug Fixes)**
    *   **静的ライブラリ重複問題の解消**: `libdm_core.a` と `dm_ai_module.so` 間でのシングルトン（`CardRegistry`）の多重インスタンス化問題が確認されました。ビルド構成を見直し、実体が確実に一つになるように修正します。
    *   **プロセス終了時のクラッシュ**: `pybind11` モジュール終了時のスレッド破棄に関連するクラッシュ（gilstate_tss_set error）の調査と修正を行います。

### 3.1 [Priority: High] Phase 4: アーキテクチャ刷新 (Architecture Update)

1.  **Transformer (Linear Attention) 導入**
    *   **目的**: 盤面のカード枚数が可変であるTCGの特性に合わせ、固定長入力のResNetから、可変長入力を扱えるAttention機構へ移行する。
    *   **計画**: `NetworkV2` として、PyTorchでのモデル定義と、C++側のテンソル変換ロジック（`TensorConverter`）の書き換えを行う。

### 3.2 [Priority: Medium] User Requested Enhancements (ユーザー要望対応)

直近のフィードバックに基づき、ユーザビリティ向上とロジックの汎用化を行います。

1.  **Game Info ウィンドウの整理**
    *   **レイアウト分離**:
        *   **上部**: ゲーム進行操作、必須情報。
        *   **下部**: AI設定、シミュレーション設定。

2.  **エンジン・ロジック拡張**
    *   **フレンド・バースト実装**: アクションに追加。内部処理用IDを自動割り振りし、ユーザーに意識させずに処理する。
    *   **ロック能力の汎用化**: `LOCK_SPELL_BY_COST` を「コスト指定ロック」として汎用化・再定義する。
    *   **新規アクション・ロジック追加**:
        *   **呪文を唱えるアクション**: ゾーン（どこから）、コスト、文明を指定して呪文を唱えるアクションを追加。
        *   **クリーチャーを出すアクション**: 召喚扱いではない「出す」処理のアクションを追加。
        *   **キーワード能力付与**: 任意対象にキーワード能力を付与するアクションを追加。
        *   **革命チェンジ簡易実装**: 種族指定（マジック・クリーチャー等）などの条件を容易に設定できるように対応。
        *   **条件付きシールド・トリガー**: 条件付きでS・トリガーを得る能力の実装方法の確立。
    *   **トリガー条件拡張**:
        *   「相手のクリーチャーが出た時」をトリガー条件に追加。
        *   「恒常能力（Passive）」選択肢の復旧・確認（見当たらないという報告の調査）。
        *   「相手のターン中、相手が2枚目以降のカードを引いたとき」のトリガータイミングを追加。
        *   トリガータイミングについて、拡張性を挙げて、汎用的なトリガータイミング+多様な条件という形で選択できるようにしたい。
        *   原子アクション：「唱えた呪文を墓地に置く代わりに山札の下に置く」を追加。1つ前のアクションで唱えたカードを入力できるようにする。
        *   条件を設定するときに「かつ」を追加できるようにしてください。
        *   メガラストバースト：バトルゾーンから離れ、手札、マナゾーン、墓地に移動したなら、このカードの呪文側をコストを支払わずに唱え(ツインパクトカード特有の効果)のキーワード能力を追加

        **エンジンで実装されているのに、カードエディタで簡単に登録できない効果がないか精査**

        **原子アクションが汎用性高く使用できるか検証**
        **GUIの日本語化推進**

1.  **シナリオエディタの機能改善 (Scenario Editor Improvements)**
    *   **ゾーン管理の構造化**: 各ゾーン（Hand, Battle Zone, Mana Zone, Shield Zone, Graveyard）をタブまたはグループで整理し、カードID配列ではなく「カード名のリスト」として管理します。
    *   **カード検索・追加機能**: カード名、文明、コスト、テキストでの検索・フィルタリング機能を実装します。
    *   **ドラッグ＆ドロップ**: 検索結果リストから各ゾーンへ直感的にカードを追加できるようにします。

2.  **カードエディタ GUI 改善 (Card Editor GUI Improvements)**
    *   **多色表示の改善**: 2色以上選択時、単純な混色（紫など）ではなく、グラデーションとして表示する。
    *   **レイアウト調整**:
        *   Imageスペースの削除。
        *   マナコストの円表示を左上に移動。
        *   パワー数値を左下に移動。
        *   カード名の下に種族を表示。
        *   カードタイプ表示下部のGenerated Text表示をやめ、キーワード能力および能力表示エリアに変更。
    *   **ツインパクト対応**:
        *   カードを上下半分に分割表示。
        *   下半分のマナコスト（円）を、下半分エリアの右上に表示。
    *   **ID管理の隠蔽**: GUI上でのカードID表示・編集を廃止し、内部処理のみとすることでユーザーからID管理を隠蔽する。
    *   **日本語化**: GUI上の表示文字を可能な限り日本語で表示する。特に、キーワード能力だけでなく、カードに登録した能力テキストもプレビューおよびGenerated Textで日本語表示されるようにする。
    *   **モード選択機能**: 「3つの中から2回選択する（重複可）」などのモード選択の実装とGUI対応。選択肢のネストを深くし、表記・表示を分かりやすくする。

### 3.3 [Priority: Low] Phase 5: エディタ機能の完成形 (Editor Polish)

AI開発と並行して、エディタの残存課題を解消します。

1.  **Logic Mask (ロジックマスク)**
    *   選択された「トリガー」に対して、意味的に無効な「効果」を選択できないようにGUI側でフィルタリングする機能。
2.  **Reaction Ability UI**
    *   ニンジャ・ストライクや革命0トリガーなどの「リアクション（手札誘発）」を編集するための専用フォームの実装。
3.  **Visual Effect Builder**
    *   ロジックツリーをノードグラフ形式で表示・編集できる高度なUI（長期目標）。
