# 17. AIアーキテクチャと将来のエンジン要件 (AI Architecture & Future Engine Requirements)

## 1. AI実装戦略 (Phase 3)

### 1.1 学習方針 (Learning Policy)
*   **アプローチ**: **教師あり学習 (模倣学習)** から開始し、後に **オンライン自己対戦 (Self-Play)** へ移行する。
    *   **Phase 3**: ヒューリスティック（ルールベース）エージェントを用いて初期の学習データを生成する。ニューラルネットワークはこのエージェントを模倣するように学習する（Cold Start対策）。
    *   **Phase 4**: ヒューリスティックの限界を超えるため、MCTSを用いた自己対戦によるオンライン学習へ移行する。

### 1.2 ネットワークアーキテクチャ (Network Architecture)
*   **関心の分離 (Separation of Concerns)**:
    *   **Policy Network (方策)**: **マスクされた情報 (Masked Information)** を入力とする。AIは「自分に見えている情報」だけでプレイすることを学習しなければならない。
    *   **Value Network (価値)**: **完全情報 (Full Information/God View)** を入力とする。相手の手札を含む全ての情報に基づいて、正確な勝率を予測することを学習する。
    *   *注記*: 実戦（推論時）ではValue Networkはマスクされた入力を使うか、あるいはPolicyのみを使用する。Phase 3ではPolicy Networkの学習を最優先とする。

### 1.3 探索戦略 (MCTS)
*   **アルゴリズム**: **Policy + Mask MCTS** (標準的なAlphaZero方式)。
*   **不確定情報**: 平均化された、あるいは未知の情報として扱う。計算コストの観点から、Phase 3ではSO-IS（決定化MCTS）は採用しない。
*   **記憶 (Memory)**: Phase 3ではLSTMやTransformerは使用しない。代わりに **特徴量エンジニアリング (Feature Engineering)** （例：「公開済みカード」フラグ）を用いて、開示された非公開領域の情報を追跡する。

---

## 2. 将来のエンジン要件 (Phase 4/5)

G・ゼロやハイパーエナジーなどの複雑なカードメカニズムをサポートするため、ゲームエンジンには大幅なリファクタリングが必要となる。

### 2.1 宣言ゾーンとスタック (Declaration Zone & Stack)
*   **概念**: 「使用宣言 (Declaration)」と「解決 (Resolution)」を明確に分離する。
*   **フロー**:
    1.  **宣言 (Declaration)**: カードを手札から「宣言ゾーン」に移動する。
    2.  **コスト算出 (Cost Calculation)**: コスト軽減を適用し、タップ対象（ハイパーエナジー）を選択し、G・ゼロ条件を確認する。
    3.  **支払い (Payment)**: マナを支払う、クリーチャーをタップする等のコストを履行する。
    4.  **解決 (Resolution)**: カードをスタックまたはバトルゾーンに移動し、効果を解決する。

### 2.2 高度なメカニズム (Advanced Mechanics)
*   **ハイパーエナジー (Hyper Energy)**: マナを支払う *前* に、タップするクリーチャーを選択する必要がある。
*   **カードの下のカード (Underlying Cards)**: `CardInstance` はカードのスタック（重なり）を保持できる構造（例: `vector<CardInstance> underlying`）に変更する必要がある（進化元、封印など）。
*   **シールド焼却 (Shield Burn)**: トリガーを使わせずにシールドを直接墓地へ送る処理。
*   **汎用タップ/アンタップ (Generic Tap/Untap)**: フィルタ条件に基づいて対象を選び、タップ・アンタップする汎用的なJSONアクション定義。

### 2.3 AIの認識能力 (AI Perception)
*   **コスト認識**: `ActionGenerator` は、マナが不足していても代替コスト（G・ゼロ）や軽減によってプレイ可能であれば、そのアクションを生成しなければならない。
*   **アクションの派生**: 「通常コストでプレイ」と「G・ゼロでプレイ」を別個のアクションとして生成する。

---

## 3. Phase 3 実装ロードマップ
1.  **TensorConverter更新**: `mask_opponent_hand` フラグのサポート（相手手札の隠蔽）。
2.  **ヒューリスティックエージェント**: データ生成用のルールベースBotの作成。
3.  **データ収集**: ヒューリスティック vs ヒューリスティックの対戦を実施し、マスクされた状態と完全情報のペアを収集する。
4.  **学習**: Masked Policy / Full Value の構成でモデルを学習させる。
