# å‘ªæ–‡ã®ã‚¾ãƒ¼ãƒ³çµŒè·¯ã¨ç½®æ›åŠ¹æœ - ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

## ã‚¾ãƒ¼ãƒ³çµŒè·¯ã®æ¯”è¼ƒ

### é€šå¸¸ã®å‘ªæ–‡ï¼ˆç½®æ›åŠ¹æœãªã—ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰‹æœ­   â”‚
â”‚  (HAND)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ ãƒ—ãƒ¬ã‚¤å®£è¨€
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ã‚¿ãƒƒã‚¯ â”‚
â”‚ (STACK)  â”‚ â† ã‚³ã‚¹ãƒˆæ”¯æ‰•ã„ï¼ˆã‚¿ãƒƒãƒ—ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ è§£æ±º
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠ¹æœå®Ÿè¡Œ â”‚
â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ è‡ªå‹•ç§»å‹•
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¢“åœ°   â”‚ âœ… å¢“åœ°ã«ç½®ã‹ã‚Œã‚‹
â”‚(GRAVEYARD)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç½®æ›åŠ¹æœã‚ã‚Šã®å‘ªæ–‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰‹æœ­   â”‚
â”‚  (HAND)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ ãƒ—ãƒ¬ã‚¤å®£è¨€
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ã‚¿ãƒƒã‚¯ â”‚
â”‚ (STACK)  â”‚ â† ã‚³ã‚¹ãƒˆæ”¯æ‰•ã„ï¼ˆã‚¿ãƒƒãƒ—ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ è§£æ±º
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠ¹æœå®Ÿè¡Œ â”‚
â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPLACE_CARD_MOVE å‡¦ç†  â”‚
â”‚  (å¢“åœ°ã¸ã®ç§»å‹•ã‚’æ¤œå‡º)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ ç½®æ›
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¢“åœ°   â”‚ â•³   â”‚ å±±æœ­ã®ä¸‹ â”‚ âœ… å®Ÿéš›ã®ç§»å‹•å…ˆ
â”‚(GRAVEYARD)â”‚     â”‚(DECK_BOT)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ã‚¹ã‚­ãƒƒãƒ—          é…ç½®ã•ã‚Œã‚‹
```

## é‡è¦ãªé•ã„

| é …ç›® | é€šå¸¸ã®å‘ªæ–‡ | ç½®æ›åŠ¹æœã‚ã‚Š |
|------|----------|------------|
| **æœ€çµ‚ã‚¾ãƒ¼ãƒ³** | GRAVEYARD | DECK_BOTTOM (ã¾ãŸã¯æŒ‡å®šã‚¾ãƒ¼ãƒ³) |
| **å¢“åœ°ãƒˆãƒªã‚¬ãƒ¼** | ç™ºå‹•ã™ã‚‹ âœ… | ç™ºå‹•ã—ãªã„ âŒ |
| **ç½®æ›å…ˆãƒˆãƒªã‚¬ãƒ¼** | ãªã— | ç™ºå‹•ã™ã‚‹ âœ… |
| **å¢“åœ°ã®ã‚«ãƒ¼ãƒ‰æ•°** | +1 | å¤‰åŒ–ãªã— (0) |

## å®Ÿè£…ã®æ ¸å¿ƒéƒ¨åˆ†

### ã‚¨ãƒ³ã‚¸ãƒ³å´ï¼ˆC++ï¼‰

**`game_logic_system.cpp` - å‘ªæ–‡è§£æ±ºå‡¦ç†**

```cpp
if (def.type == CardType::SPELL) {
    // 1. åŠ¹æœã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    for (const auto& eff : def.effects) {
        EffectSystem::instance().compile_effect(
            state, eff, instance_id, ctx, card_db, compiled_effects
        );
    }
    
    // 2. å¢“åœ°ã¸ã®ç§»å‹•ã‚’è¿½åŠ ï¼ˆè‡ªå‹•ï¼‰
    nlohmann::json move_args;
    move_args["target"] = instance_id;
    move_args["to"] = "GRAVEYARD";  // â† ã“ã“ãŒç½®æ›ã•ã‚Œã‚‹
    compiled_effects.emplace_back(InstructionOp::MOVE, move_args);
}
```

### ã‚«ãƒ¼ãƒ‰å®šç¾©å´ï¼ˆJSONï¼‰

```json
{
  "type": "SPELL",
  "effects": [
    {
      "type": "DRAW_CARD",
      "amount": 2
    },
    {
      "type": "REPLACE_CARD_MOVE",
      "from_zone": "GRAVEYARD",      // æœ¬æ¥ã®ç§»å‹•å…ˆ
      "to_zone": "DECK_BOTTOM",      // å®Ÿéš›ã®ç§»å‹•å…ˆ
      "target_group": "SELF"
    }
  ]
}
```

## GUIã‚¨ãƒ‡ã‚£ã‚¿ã§ã®è¨­å®šæ‰‹é †

1. **åŸºæœ¬åŠ¹æœã‚’è¿½åŠ **
   - ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—: `DRAW_CARD` ãªã©

2. **ç½®æ›åŠ¹æœã‚’è¿½åŠ **
   - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—: `ã‚«ãƒ¼ãƒ‰ç§»å‹• (CARD_MOVE)`
   - ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—: `ç½®æ›ã‚«ãƒ¼ãƒ‰ç§»å‹• (REPLACE_CARD_MOVE)`
   - **From Zone**: `GRAVEYARD` ï¼ˆæœ¬æ¥ã®ç§»å‹•å…ˆï¼‰
   - **To Zone**: `DECK_BOTTOM` ï¼ˆå®Ÿéš›ã®ç§»å‹•å…ˆï¼‰
   - **Target Group**: `SELF`

## ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆä¾‹

```
ã‚«ãƒ¼ãƒ‰ã‚’2æšå¼•ãã€‚
ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å¢“åœ°ã«ç½®ãã‹ã‚ã‚Šã«å±±æœ­ã®ä¸‹ã«ç½®ãã€‚
```

## å‡¦ç†ã®ä¿è¨¼

### âœ… ä¿è¨¼ã•ã‚Œã‚‹å‹•ä½œ

1. **å¢“åœ°ã‚’ã‚¹ã‚­ãƒƒãƒ—**: å‘ªæ–‡ã‚«ãƒ¼ãƒ‰ã¯å¢“åœ°ã‚¾ãƒ¼ãƒ³ã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œãªã„
2. **ç›´æ¥ç§»å‹•**: ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ç½®æ›å…ˆã‚¾ãƒ¼ãƒ³ã¸ç›´æ¥ç§»å‹•
3. **ãƒˆãƒªã‚¬ãƒ¼æ­£ç¢ºæ€§**: 
   - å¢“åœ°ãƒˆãƒªã‚¬ãƒ¼: ç™ºå‹•ã—ãªã„
   - ç½®æ›å…ˆãƒˆãƒªã‚¬ãƒ¼: æ­£å¸¸ã«ç™ºå‹•

### âŒ ç™ºç”Ÿã—ãªã„å‹•ä½œ

1. å¢“åœ°ã¸ã®ä¸€æ™‚çš„ãªé…ç½®
2. å¢“åœ°ã‹ã‚‰ã®å†ç§»å‹•
3. å¢“åœ°ãƒˆãƒªã‚¬ãƒ¼ã®ç™ºå‹•

## ãƒ†ã‚¹ãƒˆæ¤œè¨¼

```python
def test_spell_replacement():
    # å‘ªæ–‡ã‚’å”±ãˆã‚‹
    cast_spell(spell_id)
    
    # âœ… å¢“åœ°ã¯ç©º
    assert len(state.players[0].graveyard) == 0
    
    # âœ… å±±æœ­ã®ä¸‹ã«é…ç½®
    assert state.players[0].deck[0].card_id == spell_id
```

## ä½¿ç”¨ä¾‹ï¼šå®Ÿéš›ã®ã‚«ãƒ¼ãƒ‰

### ã€Œæ™‚ç©ºã®éœ§ã€ï¼ˆæ¶ç©ºã®ä¾‹ï¼‰

**åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ**:
> ã‚«ãƒ¼ãƒ‰ã‚’2æšå¼•ãã€‚
> ã“ã®å‘ªæ–‡ã‚’å”±ãˆãŸå¾Œã€å¢“åœ°ã«ç½®ãä»£ã‚ã‚Šã«å±±æœ­ã®ä¸‹ã«ç½®ãã€‚

**ã‚¾ãƒ¼ãƒ³çµŒè·¯**:
```
æ‰‹æœ­ â†’ ã‚¹ã‚¿ãƒƒã‚¯ â†’ [åŠ¹æœ: ã‚«ãƒ¼ãƒ‰2æšå¼•ã] â†’ å±±æœ­ã®ä¸‹
                                        â†‘
                                   å¢“åœ°ã‚’ã‚¹ã‚­ãƒƒãƒ—
```

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- ğŸ“„ [REPLACE_CARD_MOVE æ©Ÿèƒ½èª¬æ˜](REPLACE_CARD_MOVE_USAGE.md)
- ğŸ“„ [å‘ªæ–‡ã®ã‚¾ãƒ¼ãƒ³çµŒè·¯ã¨ç½®æ›åŠ¹æœï¼ˆè©³ç´°ç‰ˆï¼‰](SPELL_ZONE_FLOW_AND_REPLACEMENT.md)
- ğŸ§ª [ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰](../python/tests/unit/test_spell_replacement.py)

## æŠ€è¡“çš„ãªè©³ç´°

### ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚³ãƒ¼ãƒ‰ä½ç½®

- **å‘ªæ–‡è§£æ±º**: `src/engine/systems/game_logic_system.cpp:handle_resolve_play()`
- **ã‚¾ãƒ¼ãƒ³ç§»å‹•**: `src/engine/game_command/commands.cpp:TransitionCommand::execute()`
- **Pythonäº’æ›**: `dm_toolkit/engine/compat.py` (REPLACE_CARD_MOVE å‡¦ç†)

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

- **UIè¨­å®š**: `dm_toolkit/gui/editor/configs/action_config.py`
- **ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ**: `dm_toolkit/gui/editor/text_generator.py`
- **ã‚³ãƒãƒ³ãƒ‰å¤‰æ›**: `dm_toolkit/action_to_command.py`

---

**æœ€çµ‚æ›´æ–°**: 2026å¹´1æœˆ11æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Phase 4 ä»¥é™
