# 現在のゲームルールと実装状況 (v2.2)

このドキュメントは、C++エンジン (`dm::engine`) に現在実装されているゲームルールと、それらがソースコードのどこに対応しているかを概説します。

## 1. ゲームフローとターンの構造
**実装**: `src/engine/flow/phase_manager.cpp`

ゲームは `PhaseManager` によって管理される厳格なフェーズシーケンスに従います。

### フェーズシーケンス
1.  **START_OF_TURN (ターン開始)**
    *   **ルール**:
        *   アクティブプレイヤーのマナとクリーチャーがアンタップされる (`ManaSystem::untap_all`)。
        *   アクティブプレイヤーのクリーチャーから召喚酔いが取り除かれる。
        *   `AT_START_OF_TURN` (ターン開始時) 効果がキューに追加される。
    *   **遷移**: 自動的に `DRAW` フェーズへ進む。

2.  **DRAW (ドロー)**
    *   **ルール**:
        *   アクティブプレイヤーはカードを1枚引く。
        *   **例外**: 先攻プレイヤーの最初のターン (Turn 1) はドローをスキップする。
        *   **敗北条件**: ドロー時にデッキが空の場合、そのプレイヤーは敗北する (`check_game_over`)。
    *   **遷移**: 自動的に `MANA` フェーズへ進む。

3.  **MANA (マナチャージ)**
    *   **ルール**:
        *   プレイヤーは手札から1枚までマナゾーンにチャージできる。
        *   **実装**: `ActionGenerator` は手札の全カードに対する `MANA_CHARGE` アクションと、`PASS` アクションを生成する。
    *   **遷移**: プレイヤーがアクション (チャージまたはパス) を実行すると終了し、`MAIN` フェーズへ進む。

4.  **MAIN (メイン)**
    *   **ルール**:
        *   プレイヤーはクリーチャーを召喚したり、呪文を唱えたりできる。
        *   **コストシステム** (`ManaSystem::can_pay_cost`):
            *   合計コスト <= アンタップ状態のマナ数。
            *   カードの文明のマナが少なくとも1つ含まれている必要がある (ゼロ文明を除く)。
    *   **遷移**: プレイヤーが `PASS` を選択すると終了し、`ATTACK` フェーズへ進む。

5.  **ATTACK (攻撃)**
    *   **ルール**:
        *   プレイヤーは **アンタップ状態** かつ **召喚酔いしていない** クリーチャーで攻撃できる。
        *   **対象**: 相手プレイヤー または 相手の **タップ状態** のクリーチャー。
        *   **複数回攻撃**: 1ターンあたりの攻撃回数に **制限はない**。プレイヤーが `PASS` を選択するか、攻撃可能なクリーチャーがいなくなるまでフェーズは継続する。
        *   **タップ**: 攻撃するとクリーチャーはタップされる (`EffectResolver::resolve_attack`)。
    *   **遷移**:
        *   `ATTACK_PLAYER` または `ATTACK_CREATURE` が選択された場合 -> `BLOCK` フェーズへ進む。
        *   `PASS` が選択された場合 -> `END_OF_TURN` フェーズへ進む。

6.  **BLOCK (ブロック)**
    *   **ルール**:
        *   非アクティブプレイヤー (防御側) は `BLOCKER` (ブロッカー) 能力を持つクリーチャーでブロックできる。
        *   ブロッカーはアンタップ状態でなければならない。
        *   ブロックするとブロッカーはタップされる。
    *   **遷移**:
        *   ブロック (またはパス) 後、バトルが解決される (`EffectResolver::execute_battle`)。
        *   ゲームは `ATTACK` フェーズに戻る。

7.  **END_OF_TURN (ターン終了)**
    *   **ルール**:
        *   `AT_END_OF_TURN` (ターン終了時) 効果がキューに追加される。
        *   アクティブプレイヤーが交代する。
    *   **遷移**: `START_OF_TURN` フェーズへ進む。

## 2. バトルロジック
**実装**: `src/engine/effects/effect_resolver.cpp`

### バトル解決 (`execute_battle`)
1.  **パワー計算**:
    *   基本パワーは `CardDefinition` から取得される。
    *   **パワーアタッカー**: 攻撃中の場合、`power_attacker_bonus` が加算される。
2.  **結果判定**:
    *   攻撃側パワー > 防御側パワー -> 防御側が破壊される。
    *   攻撃側パワー < 防御側パワー -> 攻撃側が破壊される。
    *   攻撃側パワー = 防御側パワー -> 両方が破壊される。
3.  **特殊能力**:
    *   **スレイヤー**: スレイヤーが敗北または引き分けた場合、勝者も破壊される。
4.  **シールドブレイク** (プレイヤーへの攻撃がブロックされなかった場合):
    *   **ブレイク数**:
        *   デフォルト: 1枚
        *   `DOUBLE_BREAKER` (W・ブレイカー): 2枚
        *   `TRIPLE_BREAKER` (T・ブレイカー): 3枚
    *   シールドは手札に加えられる。
    *   **シールドトリガー**: シールドが `SHIELD_TRIGGER` を持っている場合、コストを支払わずに即座に使用できる (`resolve_use_shield_trigger`)。

## 3. カード能力 (キーワード)
**実装**: `src/core/card_def.hpp`, `src/engine/effects/effect_resolver.cpp`

*   **SPEED_ATTACKER (スピードアタッカー)**: 召喚酔いを無視する。
*   **BLOCKER (ブロッカー)**: 攻撃を自身に向けさせることができる。
*   **SLAYER (スレイヤー)**: バトルで負けた時、相手を破壊する。
*   **POWER_ATTACKER (パワーアタッカー)**: 攻撃中、パワーが増加する。
*   **DOUBLE/TRIPLE_BREAKER (W/T・ブレイカー)**: 追加のシールドをブレイクする。
*   **SHIELD_TRIGGER (S・トリガー)**: ブレイクされた時に無料で唱えることができる。
*   **EVOLUTION (進化)**: 別のクリーチャーの上に重ねて出すことができる (ロジックは `resolve_play_card` に部分的に実装済み)。

## 4. 勝利条件
**実装**: `src/engine/flow/phase_manager.cpp`

1.  **ダイレクトアタック**: シールドが0枚のプレイヤーへの攻撃が成功する。
2.  **ライブラリアウト**: 空のデッキからカードを引こうとする。
3.  **ターン制限**: 100ターンに到達する (結果: 引き分け)。

## 5. AIと自動化
*   **アクション生成**: `ActionGenerator` は上記のルールに基づいて全ての合法手を列挙する。
*   **解決**: `EffectResolver` は決定論的に変更を適用する。
*   **MCTS**: これらのルールを使用してゲーム木を探索する。

---
**「1ターン1回攻撃」に関する注記**:
エンジンは複数回の攻撃を明示的にサポートしています。`ATTACK` フェーズはループになっています。攻撃が解決された後（そしてブロック/バトルの可能性があった後）、状態は `ATTACK` フェーズに戻り、`ActionGenerator` は残りのアンタップ状態のクリーチャーに対して攻撃アクションを生成します。ターンはAI（またはプレイヤー）が明示的に `PASS` を選択したときにのみ終了します。

---

## 6. 2ターン目までの想定動作 (シミュレーション)

以下は、標準的なゲーム開始から2ターン目までのフェーズ遷移とアクションの例です。

### 1ターン目 (先攻: Player 1)
1.  **START_OF_TURN**: アンタップ処理（なし）。
2.  **DRAW**: **スキップ** (先攻1ターン目のルール)。
3.  **MANA**: 手札から1枚マナチャージ (マナ: 1)。
4.  **MAIN**:
    *   1コストのクリーチャーがいれば召喚可能。
    *   通常は何もせず `PASS`。
5.  **ATTACK**:
    *   召喚したクリーチャーがいても召喚酔いのため攻撃不可。
    *   `PASS` を選択。
6.  **END_OF_TURN**: ターン終了。Player 2へ交代。

### 1ターン目 (後攻: Player 2)
1.  **START_OF_TURN**: アンタップ処理（なし）。
2.  **DRAW**: カードを1枚引く。
3.  **MANA**: 手札から1枚マナチャージ (マナ: 1)。
4.  **MAIN**:
    *   1コストのクリーチャーがいれば召喚可能。
    *   `PASS`。
5.  **ATTACK**:
    *   `PASS`。
6.  **END_OF_TURN**: ターン終了。Player 1へ交代。

### 2ターン目 (先攻: Player 1)
1.  **START_OF_TURN**: マナをアンタップ。
2.  **DRAW**: カードを1枚引く。
3.  **MANA**: 手札から1枚マナチャージ (マナ: 2)。
4.  **MAIN**:
    *   2コストのクリーチャー（例: ブレイズ・クローなど）を召喚。
    *   残りマナ: 0。
    *   `PASS`。
5.  **ATTACK**:
    *   1ターン目に召喚したクリーチャーがいれば攻撃可能。
    *   今回召喚したクリーチャーは召喚酔い。
    *   攻撃可能なクリーチャーがいなければ `PASS`。
6.  **END_OF_TURN**: ターン終了。

### 2ターン目 (後攻: Player 2)
1.  **START_OF_TURN**: マナをアンタップ。
2.  **DRAW**: カードを1枚引く。
3.  **MANA**: 手札から1枚マナチャージ (マナ: 2)。
4.  **MAIN**:
    *   2コストのクリーチャーを召喚、または呪文を使用。
    *   `PASS`。
5.  **ATTACK**:
    *   1ターン目に召喚したクリーチャーがいれば攻撃可能。
    *   `PASS`。
6.  **END_OF_TURN**: ターン終了。
